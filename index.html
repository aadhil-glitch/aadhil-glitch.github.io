<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledgerly - Business Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Dark Theme Colors
                        'primary': '#4f46e5',
                        'primary-hover': '#4338ca',
                        'secondary': '#1f2937',
                        'secondary-hover': '#374151',
                        'background': '#111827',
                        'surface': '#1f2937',
                        'text-primary': '#f9fafb',
                        'text-secondary': '#d1d5db',
                        'accent': '#34d399',
                        'danger': '#ef4444',
                        // Sepia Light Theme Colors
                        'sepia-bg': '#fdf6e3',
                        'sepia-surface': '#fbf1c7',
                        'sepia-text': '#654321', // Dark Brown
                        'sepia-text-secondary': '#8b5e34', // Lighter Brown
                        'sepia-primary': '#a16207', // Amber-700
                        'sepia-primary-hover': '#854d0e', // Amber-800
                        'sepia-border': '#d7c095',
                        'sepia-accent': '#16a34a', // Green-600
                        'sepia-danger': '#dc2626', // Red-600
                    },
                }
            }
        }
    </script>
    <style>
        /* Base styles are for Sepia Light Theme */
        body {
            background-color: #fdf6e3; /* sepia-bg */
            color: #654321; /* sepia-text */
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
        .tab-button.active { background-color: #a16207; /* sepia-primary */ color: white; }
        .task-completed { text-decoration: line-through; color: #a3a3a3; } /* Neutral grey for both themes */
        .prose { color: #654321; /* sepia-text */ }

        /* Dark Theme Overrides */
        .dark body { background-color: #111827; /* background */ color: #f9fafb; /* text-primary */ }
        .dark .tab-button.active { background-color: #4f46e5; /* primary */ }
        .dark .prose { color: #f9fafb; /* text-primary */ }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fbf1c7; } /* sepia-surface */
        .dark ::-webkit-scrollbar-track { background: #1f2937; } /* surface */
        ::-webkit-scrollbar-thumb { background: #d7c095; border-radius: 4px; } /* sepia-border */
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        ::-webkit-scrollbar-thumb:hover { background: #8b5e34; } /* sepia-text-secondary */
        .dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
    </style>
</head>
<body class="antialiased font-sans">

    <div id="app" class="h-screen flex flex-col">
        <!-- Header -->
        <header id="main-header" class="bg-sepia-surface dark:bg-surface shadow-md p-4 flex justify-between items-center z-20 flex-shrink-0 hidden">
            <div class="flex items-center space-x-4">
                <i class="fas fa-book-open text-sepia-primary dark:text-primary text-2xl"></i>
                <h1 class="text-2xl font-bold text-sepia-text dark:text-text-primary">Ledgerly</h1>
                <button id="theme-toggle" class="text-sepia-text dark:text-text-primary text-xl px-2 py-1 rounded-md hover:bg-sepia-border dark:hover:bg-secondary">
                    <i id="theme-icon" class="fas"></i>
                </button>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sepia-text-secondary dark:text-text-secondary hidden md:inline">Current Employee:</span>
                <select id="employee-switcher" class="bg-sepia-bg dark:bg-secondary text-sepia-text dark:text-text-primary border border-sepia-border dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-sepia-primary dark:focus:ring-primary focus:outline-none"></select>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow flex flex-col md:flex-row overflow-hidden hidden">
            <!-- Left Panels -->
            <div class="w-full md:w-1/3 lg:w-1/4 bg-sepia-surface dark:bg-surface p-4 overflow-y-auto flex-shrink-0 border-r border-sepia-border dark:border-gray-700">
                <!-- Company Overview Panel -->
                <div id="company-overview-panel" class="mb-6">
                    <h2 class="text-xl font-semibold mb-3 text-sepia-text dark:text-text-primary flex items-center justify-between cursor-pointer" onclick="app.togglePanel('company-overview')">
                        <span><i class="fas fa-building mr-2 text-sepia-primary dark:text-primary"></i>Company Overview</span>
                        <i id="company-overview-toggle-icon" class="fas fa-chevron-down"></i>
                    </h2>
                    <div id="company-overview-content" class="space-y-4">
                        <!-- Employees -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">Employees</h3>
                                <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover" onclick="app.openModal('addEmployeeModal')">+ Add</button>
                            </div>
                            <ul id="employee-list" class="space-y-2 text-sm"></ul>
                        </div>
                        <!-- Stores -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">Stores</h3>
                                <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover" onclick="app.openModal('addStoreModal')">+ Add</button>
                            </div>
                            <ul id="store-list" class="space-y-2 text-sm"></ul>
                        </div>
                        <!-- Master Inventory -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">Master Inventory</h3>
                                <div>
                                    <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover mr-2" onclick="app.openModal('addProductModal')">+ Add</button>
                                    <button class="bg-green-600 text-white px-2 py-1 rounded-md text-sm hover:bg-green-700" onclick="app.openModal('delegateStockModal')">Delegate</button>
                                </div>
                            </div>
                            <div id="master-inventory-list" class="space-y-1 text-sm"></div>
                        </div>
                        <!-- All Tasks -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">All Tasks</h3>
                                <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover" onclick="app.openModal('createTaskModal')">+ Create</button>
                            </div>
                            <ul id="all-tasks-list" class="space-y-2 text-sm"></ul>
                        </div>
                    </div>
                </div>

                <!-- Accura AI Advisor Panel -->
                <div id="ai-advisor-panel">
                    <h2 class="text-xl font-semibold mb-3 text-sepia-text dark:text-text-primary flex items-center justify-between cursor-pointer" onclick="app.togglePanel('ai-advisor')">
                        <span><i class="fas fa-brain mr-2 text-sepia-primary dark:text-primary"></i>Accura AI Advisor</span>
                        <i id="ai-advisor-toggle-icon" class="fas fa-chevron-down"></i>
                    </h2>
                    <div id="ai-advisor-content" class="space-y-4">
                        <div>
                            <label for="ai-employee-select" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary mb-1">Select Employee to Analyze</label>
                            <select id="ai-employee-select" class="w-full bg-sepia-bg dark:bg-secondary text-sepia-text dark:text-text-primary border border-sepia-border dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-sepia-primary dark:focus:ring-primary focus:outline-none"></select>
                        </div>
                        <button id="generate-plan-btn" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover flex items-center justify-center" onclick="app.generateAIPlan()">
                            <span id="generate-plan-text">Generate Plan</span>
                            <i id="generate-plan-loader" class="fas fa-spinner fa-spin hidden ml-2"></i>
                        </button>
                        <div id="ai-plan-output" class="mt-4 p-3 bg-sepia-bg dark:bg-secondary rounded-md text-sm prose max-w-none">
                            <p class="text-sepia-text-secondary dark:text-gray-400">Your generated profit improvement plan will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employee-Specific Interface -->
            <div id="employee-view" class="flex-grow p-2 md:p-6 overflow-y-auto">
                <!-- Tabs -->
                <div class="mb-6 border-b border-sepia-border dark:border-gray-700">
                    <nav class="flex flex-wrap -mb-px" id="tabs-container">
                        <!-- Tabs will be dynamically inserted here -->
                    </nav>
                </div>
                <!-- Tab Content -->
                <div id="tab-content-container">
                    <!-- Dashboard -->
                    <div id="dashboard-content" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                           <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                               <h3 class="text-lg font-medium text-sepia-text-secondary dark:text-text-secondary">Total Revenue</h3>
                               <p id="dashboard-revenue" class="text-3xl font-bold text-sepia-accent dark:text-accent mt-2">$0.00</p>
                           </div>
                           <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                               <h3 class="text-lg font-medium text-sepia-text-secondary dark:text-text-secondary">Total Expenses</h3>
                               <p id="dashboard-expenses" class="text-3xl font-bold text-sepia-danger dark:text-danger mt-2">$0.00</p>
                           </div>
                           <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                               <h3 class="text-lg font-medium text-sepia-text-secondary dark:text-text-secondary">Net Profit</h3>
                               <p id="dashboard-profit" class="text-3xl font-bold text-sepia-text dark:text-text-primary mt-2">$0.00</p>
                           </div>
                        </div>
                    </div>
                    <!-- My Tasks -->
                    <div id="my-tasks-content" class="tab-content hidden">
                        <h2 class="text-2xl font-bold mb-4">My Assigned Tasks</h2>
                        <ul id="employee-tasks-list" class="space-y-3"></ul>
                    </div>
                    <!-- My Inventory -->
                    <div id="my-inventory-content" class="tab-content hidden">
                        <h2 class="text-2xl font-bold mb-4">My Delegated Inventory</h2>
                        <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow overflow-hidden">
                           <table class="min-w-full">
                               <thead class="bg-sepia-bg dark:bg-secondary">
                                   <tr>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Product Name</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Stock</th>
                                   </tr>
                               </thead>
                               <tbody id="employee-inventory-list" class="divide-y divide-sepia-border dark:divide-gray-700"></tbody>
                           </table>
                        </div>
                    </div>
                    <!-- Sales & Expenses -->
                    <div id="sales-expenses-content" class="tab-content hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">Record a Sale</h2>
                            <form id="record-sale-form" class="space-y-4">
                                <div>
                                    <label for="sale-store" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store</label>
                                    <select id="sale-store" name="storeId" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
                                </div>
                                <div>
                                    <label for="sale-product" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Product</label>
                                    <select id="sale-product" name="productId" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
                                </div>
                                <div>
                                    <label for="sale-type" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Sale Type</label>
                                    <select id="sale-type" name="saleType" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                                        <option>Cash</option>
                                        <option>Credit</option>
                                        <option>Deal</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="sale-amount" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Final Amount ($)</label>
                                    <input type="number" id="sale-amount" name="amount" step="0.01" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                                </div>
                                <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Record Sale</button>
                            </form>
                        </div>
                        <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                            <h2 class="text-2xl font-bold mb-4">Record an Expense</h2>
                            <form id="record-expense-form" class="space-y-4">
                                <div>
                                    <label for="expense-description" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Description</label>
                                    <input type="text" id="expense-description" name="description" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                                </div>
                                <div>
                                    <label for="expense-amount" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Amount ($)</label>
                                    <input type="number" id="expense-amount" name="amount" step="0.01" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                                </div>
                                <button type="submit" class="w-full bg-sepia-danger text-white py-2 rounded-md hover:bg-red-700 dark:bg-danger">Record Expense</button>
                            </form>
                        </div>
                    </div>
                     <!-- Invoices -->
                    <div id="invoices-content" class="tab-content hidden">
                        <h2 class="text-2xl font-bold mb-4">Generate Sales Receipt</h2>
                        <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
                            <form id="invoice-form" class="grid grid-cols-1 gap-6">
                                <div>
                                    <h3 class="text-lg font-semibold mb-3">Select Uninvoiced Sales</h3>
                                    <div id="uninvoiced-sales-list" class="space-y-2 max-h-60 overflow-y-auto p-2 bg-sepia-bg dark:bg-secondary rounded-md border border-sepia-border dark:border-gray-600">
                                        <p class="text-sepia-text-secondary dark:text-gray-400">No uninvoiced sales found.</p>
                                    </div>
                                </div>
                                <div>
                                     <button id="generate-pdf-btn" type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover flex items-center justify-center">
                                        <span id="generate-pdf-text">Generate & Download PDF Receipt</span>
                                        <i id="generate-pdf-loader" class="fas fa-spinner fa-spin hidden ml-2"></i>
                                     </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Ledger -->
                    <div id="ledger-content" class="tab-content hidden">
                        <h2 class="text-2xl font-bold mb-4">Transaction Ledger</h2>
                        <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow overflow-hidden">
                           <table class="min-w-full">
                               <thead class="bg-sepia-bg dark:bg-secondary">
                                   <tr>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Date</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Type</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Description</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Amount</th>
                                   </tr>
                               </thead>
                               <tbody id="ledger-list" class="divide-y divide-sepia-border dark:divide-gray-700"></tbody>
                           </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-container">
        <!-- First Time Setup Modal -->
        <div id="firstTimeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md">
                <h2 class="text-2xl font-bold mb-2 text-sepia-text dark:text-text-primary">Welcome to Ledgerly!</h2>
                <p class="text-sepia-text-secondary dark:text-text-secondary mb-6">Let's set up your first employee profile to get started.</p>
                <form id="first-employee-form">
                    <div class="mb-4">
                        <label for="first-employee-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Employee Name</label>
                        <input type="text" id="first-employee-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <div class="mb-6">
                        <label for="first-employee-position" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Position / Role</label>
                        <input type="text" id="first-employee-position" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Create Profile & Start</button>
                </form>
            </div>
        </div>

        <!-- Add Employee Modal -->
        <div id="addEmployeeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('addEmployeeModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Add New Employee</h2>
                <form id="add-employee-form">
                     <div class="mb-4">
                        <label for="new-employee-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Employee Name</label>
                        <input type="text" id="new-employee-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <div class="mb-6">
                        <label for="new-employee-position" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Position / Role</label>
                        <input type="text" id="new-employee-position" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Add Employee</button>
                </form>
            </div>
        </div>

        <!-- Add Store Modal -->
        <div id="addStoreModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('addStoreModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Add New Store</h2>
                <form id="add-store-form">
                     <div class="mb-4">
                        <label for="new-store-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store Name / Location</label>
                        <input type="text" id="new-store-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Add Store</button>
                </form>
            </div>
        </div>
        
        <!-- Add Product Modal -->
        <div id="addProductModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('addProductModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Add New Product</h2>
                <form id="add-product-form">
                     <div class="mb-4">
                        <label for="new-product-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Product Name</label>
                        <input type="text" id="new-product-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <div class="mb-4">
                        <label for="new-product-price" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Price ($)</label>
                        <input type="number" step="0.01" id="new-product-price" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                     <div class="mb-6">
                        <label for="new-product-stock" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Initial Stock</label>
                        <input type="number" id="new-product-stock" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Add Product</button>
                </form>
            </div>
        </div>

        <!-- Delegate Stock Modal -->
        <div id="delegateStockModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('delegateStockModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Delegate Stock to Employee</h2>
                <form id="delegate-stock-form">
                     <div class="mb-4">
                        <label for="delegate-employee" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Employee</label>
                        <select id="delegate-employee" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
                    </div>
                    <div class="mb-4">
                        <label for="delegate-product" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Product</label>
                         <select id="delegate-product" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
                    </div>
                     <div class="mb-6">
                        <label for="delegate-quantity" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Quantity</label>
                        <input type="number" id="delegate-quantity" min="1" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Delegate Stock</button>
                </form>
            </div>
        </div>
        
        <!-- Create Task Modal -->
        <div id="createTaskModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
                <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('createTaskModal')"><i class="fas fa-times"></i></button>
                <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Create New Task</h2>
                <form id="create-task-form">
                     <div class="mb-4">
                        <label for="new-task-description" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Task Description</label>
                        <input type="text" id="new-task-description" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    </div>
                    <div class="mb-6">
                        <label for="new-task-assignee" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Assign To</label>
                        <select id="new-task-assignee" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
                    </div>
                    <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Create Task</button>
                </form>
            </div>
        </div>
    </div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {

    const app = {
        // --- STATE ---
        state: {
            theme: 'dark', // 'dark' or 'light'
            currentEmployeeId: null,
            employees: [],
            stores: [],
            masterInventory: [],
            tasks: [],
        },
        
        // --- API KEYS ---
        pdfShiftApiKey: 'Sk_4e4b1acfcab0c0454d642ef6701891a8d318d648',

        // --- INITIALIZATION ---
        init() {
            this.loadState();
            this.applyTheme(); // Apply theme on initial load
            this.addEventListeners();

            if (this.state.employees.length === 0) {
                this.showFirstTimeSetup();
            } else {
                this.showMainApp();
                if (!this.state.currentEmployeeId) {
                    this.state.currentEmployeeId = this.state.employees[0].id;
                }
                this.render();
            }
        },
        
        showFirstTimeSetup() {
            document.getElementById('firstTimeModal').classList.remove('hidden');
        },
        
        showMainApp() {
            document.getElementById('firstTimeModal').classList.add('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('main-content').classList.add('flex');
        },

        // --- STATE MANAGEMENT ---
        saveState() {
            localStorage.setItem('ledgerlyState', JSON.stringify(this.state));
        },

        loadState() {
            const savedState = localStorage.getItem('ledgerlyState');
            if (savedState) {
                // Merge saved state with default state to prevent errors if new properties are added
                this.state = Object.assign({}, this.state, JSON.parse(savedState));
            }
        },
        
        // --- DATA HELPERS ---
        getEmployee(employeeId) {
            return this.state.employees.find(e => e.id === employeeId);
        },
        
        getProduct(productId) {
            return this.state.masterInventory.find(p => p.id === productId);
        },

        getStore(storeId) {
            return this.state.stores.find(s => s.id === storeId);
        },
        
        // --- EVENT LISTENERS ---
        addEventListeners() {
            // Theme toggler
            document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
            
            // First time setup
            document.getElementById('first-employee-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('first-employee-name').value;
                const position = document.getElementById('first-employee-position').value;
                if (!name || !position) return;
                
                const newEmployee = this.createEmployee(name, position);
                this.state.employees.push(newEmployee);
                this.state.currentEmployeeId = newEmployee.id;
                
                this.saveState();
                this.showMainApp();
                this.render();
            });
            
            // Employee switcher
            document.getElementById('employee-switcher').addEventListener('change', (e) => {
                this.state.currentEmployeeId = e.target.value;
                this.saveState();
                this.render();
            });

            // Tabs
            document.getElementById('tabs-container').addEventListener('click', (e) => {
                const button = e.target.closest('.tab-button');
                if (button) {
                    const tabName = button.dataset.tab;
                    this.setActiveTab(tabName);
                }
            });

            // --- Form Submissions ---
            document.getElementById('add-employee-form').addEventListener('submit', e => this.handleAddEmployee(e));
            document.getElementById('add-store-form').addEventListener('submit', e => this.handleAddStore(e));
            document.getElementById('add-product-form').addEventListener('submit', e => this.handleAddProduct(e));
            document.getElementById('delegate-stock-form').addEventListener('submit', e => this.handleDelegateStock(e));
            document.getElementById('create-task-form').addEventListener('submit', e => this.handleCreateTask(e));
            document.getElementById('record-sale-form').addEventListener('submit', e => this.handleRecordSale(e));
            document.getElementById('record-expense-form').addEventListener('submit', e => this.handleRecordExpense(e));
            document.getElementById('invoice-form').addEventListener('submit', e => this.handleGenerateInvoice(e));
        },

        // --- UI RENDERING ---
        render() {
            if (this.state.employees.length === 0) return;
            
            // Render non-employee specific parts
            this.renderEmployeeSwitcher();
            this.renderCompanyOverview();
            this.renderAIAdvisorPanel();
            
            // Render employee-specific parts
            if (this.state.currentEmployeeId) {
                this.renderTabs();
                this.setActiveTab('dashboard'); // Default to dashboard on render
            }
        },

        renderEmployeeSwitcher() {
            const switcher = document.getElementById('employee-switcher');
            switcher.innerHTML = this.state.employees.map(emp => 
                `<option value="${emp.id}" ${emp.id === this.state.currentEmployeeId ? 'selected' : ''}>${emp.name}</option>`
            ).join('');
            
            const aiSwitcher = document.getElementById('ai-employee-select');
             aiSwitcher.innerHTML = this.state.employees.map(emp => 
                `<option value="${emp.id}">${emp.name}</option>`
            ).join('');
        },
        
        renderCompanyOverview() {
      // Employees
      const employeeList = document.getElementById('employee-list');
      employeeList.innerHTML = this.state.employees.map(emp => 
        `<li class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-2 rounded">
          <div>
            <span class="text-sepia-text dark:text-text-primary">${emp.name}</span>
            <em class="text-sepia-text-secondary dark:text-gray-400 text-xs">(${emp.position})</em>
          </div>
          <div>
            <i class="fas fa-trash action-icon danger" onclick="app.handleDelete('employee', '${emp.id}')"></i>
          </div>
        </li>`
      ).join('') || `<p class="text-sepia-text-secondary dark:text-gray-400 text-sm">No employees yet.</p>`;

      // Stores
      const storeList = document.getElementById('store-list');
      storeList.innerHTML = this.state.stores.map(store => 
        `<li class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-2 rounded">
          <span class="text-sepia-text dark:text-text-primary">${store.name}</span>
          <div>
            <i class="fas fa-trash action-icon danger" onclick="app.handleDelete('store', '${store.id}')"></i>
          </div>
        </li>`
      ).join('') || `<p class="text-sepia-text-secondary dark:text-gray-400 text-sm">No stores added yet.</p>`;

      // Master Inventory
      const inventoryList = document.getElementById('master-inventory-list');
      inventoryList.innerHTML = this.state.masterInventory.map(prod => `
        <div class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-2 rounded">
          <span class="text-sepia-text dark:text-text-primary">${prod.name}</span>
          <div class="flex items-center">
            <span class="font-mono text-xs bg-sepia-border dark:bg-gray-700 px-2 py-1 rounded">${prod.stock}</span>
            <i class="fas fa-trash action-icon danger" onclick="app.handleDelete('product', '${prod.id}')"></i>
          </div>
        </div>`
      ).join('') || `<p class="text-sepia-text-secondary dark:text-gray-400 text-sm">No products in inventory.</p>`;

      // All Tasks (no changes here, just for context)
      const allTasksList = document.getElementById('all-tasks-list');
      allTasksList.innerHTML = this.state.tasks.map(task => {
        const assignee = this.getEmployee(task.assigneeId);
        return `<li class="bg-sepia-bg dark:bg-secondary p-2 rounded text-sepia-text dark:text-gray-300 ${task.status === 'Completed' ? 'task-completed' : ''}">
          <p>${task.description}</p>
          <small class="text-sepia-text-secondary dark:text-gray-400">Assigned to: ${assignee ? assignee.name : 'Unassigned'}</small>
        </li>`
      }).join('') || `<p class="text-sepia-text-secondary dark:text-gray-400 text-sm">No tasks created.</p>`;
    },
        
        renderAIAdvisorPanel() {
             const aiSwitcher = document.getElementById('ai-employee-select');
             aiSwitcher.innerHTML = this.state.employees.map(emp => 
                `<option value="${emp.id}">${emp.name}</option>`
            ).join('');
        },

        renderTabs() {
            const tabs = [
                { id: 'dashboard', name: 'Dashboard', icon: 'fa-chart-line' },
                { id: 'my-tasks', name: 'My Tasks', icon: 'fa-tasks' },
                { id: 'my-inventory', name: 'My Inventory', icon: 'fa-boxes' },
                { id: 'sales-expenses', name: 'Sales & Expenses', icon: 'fa-exchange-alt' },
                { id: 'invoices', name: 'Invoices', icon: 'fa-file-invoice-dollar' },
                { id: 'ledger', name: 'Ledger', icon: 'fa-history' },
            ];

            const tabsContainer = document.getElementById('tabs-container');
            tabsContainer.innerHTML = tabs.map(tab => `
                <button data-tab="${tab.id}" class="tab-button text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary hover:bg-sepia-surface dark:hover:bg-secondary py-3 px-4 font-medium text-sm rounded-t-lg">
                    <i class="fas ${tab.icon} mr-2 hidden md:inline"></i>${tab.name}
                </button>
            `).join('');
        },
        
        renderDashboard() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            if (!employee) return;

            const revenue = employee.transactions
                .filter(t => t.type === 'sale')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expenses = employee.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const profit = revenue - expenses;

            document.getElementById('dashboard-revenue').textContent = `$${revenue.toFixed(2)}`;
            document.getElementById('dashboard-expenses').textContent = `$${expenses.toFixed(2)}`;
            document.getElementById('dashboard-profit').textContent = `$${profit.toFixed(2)}`;
            document.getElementById('dashboard-profit').classList.toggle('text-sepia-danger', profit < 0);
            document.getElementById('dashboard-profit').classList.toggle('dark:text-danger', profit < 0);
            document.getElementById('dashboard-profit').classList.toggle('text-sepia-text', profit >= 0);
            document.getElementById('dashboard-profit').classList.toggle('dark:text-text-primary', profit >= 0);
        },
        
        renderMyTasks() {
            const employeeTasks = this.state.tasks.filter(t => t.assigneeId === this.state.currentEmployeeId);
            const listEl = document.getElementById('employee-tasks-list');
            listEl.innerHTML = employeeTasks.map(task => `
                <li class="bg-sepia-surface dark:bg-surface p-4 rounded-lg shadow flex justify-between items-center ${task.status === 'Completed' ? 'task-completed' : ''}">
                    <span class="text-sepia-text dark:text-text-primary">${task.description}</span>
                    <button class="text-white px-3 py-1 rounded-md text-sm ${task.status === 'Completed' ? 'bg-gray-500' : 'bg-green-600 hover:bg-green-700'}" onclick="app.toggleTaskStatus('${task.id}')">
                        ${task.status === 'Completed' ? 'Reopen' : 'Complete'}
                    </button>
                </li>
            `).join('') || `<p class="text-sepia-text-secondary dark:text-gray-400">You have no assigned tasks.</p>`;
        },
        
        renderMyInventory() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const listEl = document.getElementById('employee-inventory-list');
            if (!employee || !employee.inventory || employee.inventory.length === 0) {
                 listEl.innerHTML = `<tr><td colspan="2" class="px-6 py-4 text-center text-sepia-text-secondary dark:text-gray-400">No inventory delegated to you.</td></tr>`;
                 return;
            }
            
            listEl.innerHTML = employee.inventory.map(item => {
                const product = this.getProduct(item.productId);
                return `
                    <tr class="hover:bg-sepia-bg dark:hover:bg-secondary">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${product ? product.name : 'Unknown Product'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text-secondary dark:text-text-secondary">${item.stock}</td>
                    </tr>
                `;
            }).join('');
        },
        
        renderSalesAndExpenses() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const saleProductSelect = document.getElementById('sale-product');
            const saleStoreSelect = document.getElementById('sale-store');
            
            // Populate stores
            if (this.state.stores.length === 0) {
                saleStoreSelect.innerHTML = `<option disabled selected>Add a store first</option>`;
                saleStoreSelect.disabled = true;
            } else {
                saleStoreSelect.innerHTML = this.state.stores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                saleStoreSelect.disabled = false;
            }

            // Populate products
            if (!employee || !employee.inventory || employee.inventory.length === 0) {
                saleProductSelect.innerHTML = `<option disabled selected>No inventory to sell</option>`;
                saleProductSelect.disabled = true;
            } else {
                 saleProductSelect.innerHTML = employee.inventory
                    .filter(item => item.stock > 0)
                    .map(item => {
                        const product = this.getProduct(item.productId);
                        return `<option value="${product.id}">${product.name} (Stock: ${item.stock})</option>`;
                    }).join('');
                saleProductSelect.disabled = false;
            }

            // Disable form button if no stores or products
            const canSell = this.state.stores.length > 0 && employee?.inventory?.some(i => i.stock > 0);
            document.querySelector('#record-sale-form button').disabled = !canSell;
        },
        
        renderInvoices() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const listEl = document.getElementById('uninvoiced-sales-list');
            const uninvoicedSales = employee.transactions.filter(t => t.type === 'sale' && !t.invoiced);

            if (uninvoicedSales.length === 0) {
                listEl.innerHTML = `<p class="text-sepia-text-secondary dark:text-gray-400 p-2">No uninvoiced sales found.</p>`;
                document.getElementById('generate-pdf-btn').disabled = true;
            } else {
                 document.getElementById('generate-pdf-btn').disabled = false;
                 listEl.innerHTML = uninvoicedSales.map(sale => {
                    const product = this.getProduct(sale.productId);
                    return `
                        <label class="flex items-center space-x-3 p-2 bg-sepia-surface dark:bg-gray-700 rounded-md hover:bg-sepia-border dark:hover:bg-gray-600 cursor-pointer">
                            <input type="checkbox" name="invoice-sale" value="${sale.id}" class="form-checkbox h-5 w-5 text-sepia-primary dark:text-primary bg-sepia-bg dark:bg-secondary border-sepia-border dark:border-gray-600 rounded focus:ring-sepia-primary dark:focus:ring-primary">
                            <span class="text-sm text-sepia-text dark:text-text-primary">
                                ${new Date(sale.date).toLocaleDateString()}: ${product.name} - $${sale.amount.toFixed(2)}
                            </span>
                        </label>
                    `
                 }).join('');
            }
        },

        renderLedger() {
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const listEl = document.getElementById('ledger-list');
            if (!employee || employee.transactions.length === 0) {
                listEl.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-sepia-text-secondary dark:text-gray-400">No transactions recorded yet.</td></tr>`;
                return;
            }

            const sortedTransactions = [...employee.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            listEl.innerHTML = sortedTransactions.map(t => {
                const isSale = t.type === 'sale';
                let description = '';
                if(isSale) {
                    const product = this.getProduct(t.productId);
                    const store = this.getStore(t.storeId);
                    description = `Sale: ${product?.name || 'N/A'} at ${store?.name || 'N/A'}`;
                } else {
                    description = t.description;
                }
                const amountClass = isSale ? 'text-sepia-accent dark:text-accent' : 'text-sepia-danger dark:text-danger';
                return `
                    <tr class="hover:bg-sepia-bg dark:hover:bg-secondary">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text-secondary dark:text-text-secondary">${new Date(t.date).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text-secondary dark:text-text-secondary capitalize">${t.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${amountClass}">
                            ${isSale ? '+' : '-'}$${t.amount.toFixed(2)}
                        </td>
                    </tr>
                `;
            }).join('');
        },

        // --- UI LOGIC ---
        applyTheme() {
            const themeIcon = document.getElementById('theme-icon');
            if (this.state.theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        },

        toggleTheme() {
            this.state.theme = this.state.theme === 'dark' ? 'light' : 'dark';
            this.applyTheme();
            this.saveState();
        },

        setActiveTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Call the specific render function for the active tab to ensure data is fresh
            switch(tabName) {
                case 'dashboard': this.renderDashboard(); break;
                case 'my-tasks': this.renderMyTasks(); break;
                case 'my-inventory': this.renderMyInventory(); break;
                case 'sales-expenses': this.renderSalesAndExpenses(); break;
                case 'invoices': this.renderInvoices(); break;
                case 'ledger': this.renderLedger(); break;
            }
        },
        
        openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // Populate modal forms if necessary
            if (modalId === 'delegateStockModal') {
                const employeeSelect = document.getElementById('delegate-employee');
                const productSelect = document.getElementById('delegate-product');
                employeeSelect.innerHTML = this.state.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                productSelect.innerHTML = this.state.masterInventory.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.stock})</option>`).join('');
            }
             if (modalId === 'createTaskModal') {
                const assigneeSelect = document.getElementById('new-task-assignee');
                assigneeSelect.innerHTML = this.state.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            }
            
            modal.classList.remove('hidden');
        },
        
        closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        },

        togglePanel(panelName) {
            const content = document.getElementById(`${panelName}-content`);
            const icon = document.getElementById(`${panelName}-toggle-icon`);
            content.classList.toggle('hidden');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
        },
        
        // --- ACTION HANDLERS ---
        createEmployee(name, position) {
            return {
                id: `emp_${Date.now()}`,
                name,
                position,
                inventory: [],
                transactions: []
            };
        },
        
        handleAddEmployee(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#new-employee-name').value;
            const position = form.querySelector('#new-employee-position').value;
            if (!name || !position) return;
            
            this.state.employees.push(this.createEmployee(name, position));
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('addEmployeeModal');
        },

        handleAddStore(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#new-store-name').value;
            if (!name) return;
            
            this.state.stores.push({ id: `store_${Date.now()}`, name });
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('addStoreModal');
        },
        
        handleAddProduct(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.querySelector('#new-product-name').value;
            const price = parseFloat(form.querySelector('#new-product-price').value);
            const stock = parseInt(form.querySelector('#new-product-stock').value, 10);
            if (!name || isNaN(price) || isNaN(stock)) return;

            this.state.masterInventory.push({ id: `prod_${Date.now()}`, name, price, stock });
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('addProductModal');
        },
        
        handleDelegateStock(e) {
            e.preventDefault();
            const form = e.target;
            const employeeId = form.querySelector('#delegate-employee').value;
            const productId = form.querySelector('#delegate-product').value;
            const quantity = parseInt(form.querySelector('#delegate-quantity').value, 10);
            
            const masterProduct = this.getProduct(productId);
            if (!employeeId || !productId || isNaN(quantity) || quantity <= 0 || !masterProduct) return;

            if (masterProduct.stock < quantity) {
                alert('Not enough stock in master inventory.');
                return;
            }

            masterProduct.stock -= quantity;
            const employee = this.getEmployee(employeeId);
            let employeeProduct = employee.inventory.find(item => item.productId === productId);
            if (employeeProduct) {
                employeeProduct.stock += quantity;
            } else {
                employee.inventory.push({ productId, stock: quantity });
            }
            
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('delegateStockModal');
        },
        
        handleCreateTask(e) {
            e.preventDefault();
            const form = e.target;
            const description = form.querySelector('#new-task-description').value;
            const assigneeId = form.querySelector('#new-task-assignee').value;
            if (!description || !assigneeId) return;

            this.state.tasks.push({ id: `task_${Date.now()}`, description, assigneeId, status: 'In Progress' });
            this.saveState();
            this.render();
            form.reset();
            this.closeModal('createTaskModal');
        },
        
        toggleTaskStatus(taskId) {
            const task = this.state.tasks.find(t => t.id === taskId);
            if (task) {
                task.status = task.status === 'Completed' ? 'In Progress' : 'Completed';
                this.saveState();
                this.render(); // Re-render both company overview and my tasks
                this.setActiveTab('my-tasks');
            }
        },

        handleRecordSale(e) {
            e.preventDefault();
            const form = e.target;
            const storeId = form.querySelector('#sale-store').value;
            const productId = form.querySelector('#sale-product').value;
            const amount = parseFloat(form.querySelector('#sale-amount').value);
            const employee = this.getEmployee(this.state.currentEmployeeId);
            const employeeInventoryItem = employee.inventory.find(i => i.productId === productId);

            if (!storeId || !productId || isNaN(amount) || !employeeInventoryItem || employeeInventoryItem.stock <= 0) {
                alert('Invalid sale data. Ensure a store is selected and the product is in stock.');
                return;
            }

            employeeInventoryItem.stock -= 1;
            employee.transactions.push({
                id: `txn_${Date.now()}`,
                type: 'sale',
                storeId,
                productId,
                amount,
                date: new Date().toISOString(),
                invoiced: false,
            });

            this.saveState();
            this.render();
            this.setActiveTab('sales-expenses');
            form.reset();
        },

        handleRecordExpense(e) {
            e.preventDefault();
            const form = e.target;
            const description = form.querySelector('#expense-description').value;
            const amount = parseFloat(form.querySelector('#expense-amount').value);
            
            if (!description || isNaN(amount)) {
                alert('Invalid expense data.');
                return;
            }

            const employee = this.getEmployee(this.state.currentEmployeeId);
            employee.transactions.push({ id: `txn_${Date.now()}`, type: 'expense', description, amount, date: new Date().toISOString() });
            
            this.saveState();
            this.render();
            this.setActiveTab('sales-expenses');
            form.reset();
        },

        async handleGenerateInvoice(e) {
            e.preventDefault();
            const form = e.target;
            const selectedSalesIds = Array.from(form.querySelectorAll('input[name="invoice-sale"]:checked')).map(cb => cb.value);

            if (selectedSalesIds.length === 0) {
                alert('Please select at least one sale to include in the receipt.');
                return;
            }
            
            const btn = document.getElementById('generate-pdf-btn');
            const btnText = document.getElementById('generate-pdf-text');
            const loader = document.getElementById('generate-pdf-loader');
            
            btn.disabled = true;
            btnText.textContent = 'Generating...';
            loader.classList.remove('hidden');

            const employee = this.getEmployee(this.state.currentEmployeeId);
            const salesToInvoice = employee.transactions.filter(t => selectedSalesIds.includes(t.id));
            const totalAmount = salesToInvoice.reduce((sum, sale) => sum + sale.amount, 0);

            const invoiceHtml = this.generateInvoiceHtml(employee, salesToInvoice, totalAmount);
            
            try {
                const response = await fetch('https://api.pdfshift.io/v3/convert/pdf', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa('api:' + this.pdfShiftApiKey),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ source: invoiceHtml, landscape: false })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`PDF Generation Failed: ${error.message}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Receipt_${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
                salesToInvoice.forEach(sale => sale.invoiced = true);
                this.saveState();
                this.render();
                this.setActiveTab('invoices');

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert(`Could not generate PDF. Please check the console for details. ${error.message}`);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Generate & Download PDF Receipt';
                loader.classList.add('hidden');
                form.reset();
            }
        },

        generateInvoiceHtml(employee, sales, total) {
            const itemsHtml = sales.map(sale => {
                const product = this.getProduct(sale.productId);
                const store = this.getStore(sale.storeId);
                return `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee;">${product.name} (Sold at ${store.name})</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">1</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">$${sale.amount.toFixed(2)}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: right;">$${sale.amount.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body { font-family: sans-serif; color: #333; }
                        .container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #eee; box-shadow: 0 0 10px rgba(0,0,0,0.15); }
                        .header { margin-bottom: 40px; }
                        .details { margin-bottom: 40px; }
                        .table { width: 100%; border-collapse: collapse; }
                        .table th { background: #f9f9f9; text-align: left; padding: 8px; border-bottom: 2px solid #ddd; }
                        .total { text-align: right; margin-top: 20px; font-size: 1.2em; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>Sales Receipt</h1>
                            <p>Receipt ID: RCPT_${Date.now()}</p>
                        </div>
                        <div class="details">
                            <strong>Generated By:</strong><br>
                            ${employee.name} (${employee.position})<br>
                            Date: ${new Date().toLocaleDateString()}
                        </div>
                        <table class="table">
                            <thead>
                                <tr><th>Item</th><th>Quantity</th><th>Unit Price</th><th>Total</th></tr>
                            </thead>
                            <tbody>${itemsHtml}</tbody>
                        </table>
                        <div class="total">
                            Total: $${total.toFixed(2)}
                        </div>
                    </div>
                </body>
                </html>
            `;
        },

        // --- MOCK AI ADVISOR ---
        async generateAIPlan() {
            // This function remains the same as it was not part of the requested changes.
            const employeeId = document.getElementById('ai-employee-select').value;
            const employee = this.getEmployee(employeeId);
            if (!employee) return;

            const btn = document.getElementById('generate-plan-btn');
            const btnText = document.getElementById('generate-plan-text');
            const loader = document.getElementById('generate-plan-loader');
            
            btn.disabled = true;
            btnText.textContent = 'Analyzing...';
            loader.classList.remove('hidden');
            document.getElementById('ai-plan-output').innerHTML = `<p class="text-sepia-text-secondary dark:text-gray-400">Accura AI is analyzing the data...</p>`;
            
            const revenue = employee.transactions.filter(t => t.type === 'sale').reduce((s, t) => s + t.amount, 0);
            const expenses = employee.transactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            const profit = revenue - expenses;
            const recentTransactions = employee.transactions.slice(-5).map(t => {
                const desc = t.type === 'sale' ? `Sale of ${this.getProduct(t.productId)?.name}` : t.description;
                return `${t.type.toUpperCase()}: $${t.amount.toFixed(2)} - ${desc}`;
            });
            
            const plan = await this.mockGeminiAPI(employee.name, revenue, expenses, profit, recentTransactions);

            document.getElementById('ai-plan-output').innerHTML = this.simpleMarkdownToHtml(plan);
            
            btn.disabled = false;
            btnText.textContent = 'Generate Plan';
            loader.classList.add('hidden');
        },
        
        async mockGeminiAPI(name, revenue, expenses, profit, transactions) {
            // This function also remains the same.
            return new Promise(resolve => {
                setTimeout(() => {
                    const advice = [];
                    if (profit < 0) advice.push(`- **Address Negative Profit:** The current net profit is -$${Math.abs(profit).toFixed(2)}. Prioritize cost reduction or boosting high-margin sales immediately.`);
                    else advice.push(`- **Leverage Positive Profit:** With a net profit of $${profit.toFixed(2)}, consider reinvesting in top-selling products or marketing efforts to scale up.`);
                    if (expenses > revenue * 0.5 && revenue > 0) advice.push(`- **Review High Expenses:** Expenses ($${expenses.toFixed(2)}) are more than 50% of revenue ($${revenue.toFixed(2)}). Conduct a detailed review of all expenses to identify potential savings.`);
                    else if (expenses === 0 && revenue > 0) advice.push(`- **Track All Expenses:** No expenses have been recorded. Ensure all business-related costs are logged to get an accurate view of profitability.`);
                    else advice.push(`- **Maintain Expense Control:** Expenses are currently well-managed relative to revenue. Continue monitoring to maintain this healthy ratio.`);
                    if (transactions.some(t => t.includes('DEAL'))) advice.push(`- **Analyze Deal Performance:** Multiple 'Deal' type sales were recorded. Analyze if these deals are leading to repeat business or if they are impacting overall margin too heavily.`);
                    advice.push(`- **Focus on Top Sellers:** Identify which products are sold most frequently and ensure adequate stock levels for them.`);
                    const response = `### Profit Plan for ${name}\n\n**1. Key Observations:**\n*   **Total Revenue:** $${revenue.toFixed(2)}\n*   **Total Expenses:** $${expenses.toFixed(2)}\n*   **Net Profit:** $${profit.toFixed(2)}\n\n**2. Actionable Steps:**\n${advice.join('\n')}\n\n**3. Next Steps:**\nFocus on implementing one of these suggestions this week and track the impact on your net profit.`;
                    resolve(response.trim());
                }, 1500);
            });
        },
        
        simpleMarkdownToHtml(md) {
            // This function also remains the same.
            let html = md;
            html = html.replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold mt-5 mb-3">$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-6 mb-4">$1</h1>');
            html = html.replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>');
            html = html.replace(/^\* (.*$)/gim, '<li class="ml-4">$1</li>');
            html = html.replace(/<\/li>\n<li/gim, '</li><li');
            html = html.replace(/(<li.*<\/li>)/gs, '<ul class="list-disc list-inside space-y-1">$1</ul>');
            html = html.replace(/\n/g, '<br>');
            html = html.replace(/<br><ul/g, '<ul');
            html = html.replace(/ul><br>/g, 'ul>');
            html = html.replace(/<br><h/g, '<h');
            html = html.replace(/h3><br>/g, 'h3>');
            return html;
        }
    };

    app.init();
    window.app = app; 
});
</script>

</body>
</html>
