
<!DOCTYPE html><html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Ledgerly - Business Management</title> <script src="https://cdn.tailwindcss.com"></script> <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"> <script> tailwind.config = { darkMode: 'class', theme: { extend: { colors: { 'primary': '#4f46e5', 'primary-hover': '#4338ca', 'secondary': '#1f2937', 'secondary-hover': '#374151', 'background': '#111827', 'surface': '#1f2937', 'text-primary': '#f9fafb', 'text-secondary': '#d1d5db', 'accent': '#34d399', 'danger': '#ef4444', 'sepia-bg': '#fdf6e3', 'sepia-surface': '#fbf1c7', 'sepia-text': '#654321', 'sepia-text-secondary': '#8b5e34', 'sepia-primary': '#a16207', 'sepia-primary-hover': '#854d0e', 'sepia-border': '#d7c095', 'sepia-accent': '#16a34a', 'sepia-danger': '#dc2626', }, } } } </script> <style> body { background-color: #fdf6e3; color: #654321; } .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); } .tab-button.active { background-color: #a16207; color: white; } .task-completed { text-decoration: line-through; color: #a3a3a3; } .prose { color: #654321; } .dark body { background-color: #111827; color: #f9fafb; } .dark .tab-button.active { background-color: #4f46e5; } .dark .prose { color: #f9fafb; } ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #fbf1c7; } .dark ::-webkit-scrollbar-track { background: #1f2937; } ::-webkit-scrollbar-thumb { background: #d7c095; border-radius: 4px; } .dark ::-webkit-scrollbar-thumb { background: #4a5568; } ::-webkit-scrollbar-thumb:hover { background: #8b5e34; } .dark ::-webkit-scrollbar-thumb:hover { background: #718096; } .toast { padding: 1rem; border-radius: 0.5rem; color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); transform: translateX(120%); transition: transform 0.3s ease-in-out; opacity: 0; } .toast.show { transform: translateX(0); opacity: 1; } .toast.success { background-color: #16a34a; } .toast.danger { background-color: #dc2626; } .toast.info { background-color: #2563eb; } .action-icon { cursor: pointer; margin-left: 0.75rem; color: #8b5e34; font-size: 0.9rem; } .dark .action-icon { color: #9ca3af; } .action-icon.danger:hover { color: #dc2626; } .dark .action-icon.danger:hover { color: #ef4444; } .action-icon:hover { color: #654321; } .dark .action-icon:hover { color: #f9fafb; } </style> </head> <body class="antialiased font-sans"> <div id="app" class="h-screen flex flex-col"> <!-- Header --> <header id="main-header" class="bg-sepia-surface dark:bg-surface shadow-md p-4 flex justify-between items-center z-20 flex-shrink-0 hidden"> <div class="flex items-center space-x-4"> <i class="fas fa-book-open text-sepia-primary dark:text-primary text-2xl"></i> <h1 class="text-2xl font-bold text-sepia-text dark:text-text-primary">Ledgerly</h1> <button id="theme-toggle" class="text-sepia-text dark:text-text-primary text-xl px-2 py-1 rounded-md hover:bg-sepia-border dark:hover:bg-secondary"><i id="theme-icon" class="fas"></i></button> </div> <div class="flex items-center space-x-4"> <span class="text-sepia-text-secondary dark:text-text-secondary hidden md:inline">Current Employee:</span> <select id="employee-switcher" class="bg-sepia-bg dark:bg-secondary text-sepia-text dark:text-text-primary border border-sepia-border dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-sepia-primary dark:focus:ring-primary focus:outline-none"></select> </div> </header>
<!-- Main Content -->
<main id="main-content" class="flex-grow flex flex-col md:flex-row overflow-hidden hidden">
  <!-- Left Panels -->
  <div class="w-full md:w-1/3 lg:w-1/4 bg-sepia-surface dark:bg-surface p-4 overflow-y-auto flex-shrink-0 border-r border-sepia-border dark:border-gray-700">
    <!-- Company Overview Panel -->
    <div id="company-overview-panel" class="mb-6">
      <h2 class="text-xl font-semibold mb-3 text-sepia-text dark:text-text-primary flex items-center justify-between cursor-pointer" onclick="app.togglePanel('company-overview')">
        <span><i class="fas fa-building mr-2 text-sepia-primary dark:text-primary"></i>Company Overview</span>
        <i id="company-overview-toggle-icon" class="fas fa-chevron-down"></i>
      </h2>
      <div id="company-overview-content" class="space-y-4">
        <!-- Employees -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">Employees</h3>
            <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover" onclick="app.openModal('addEmployeeModal')">+ Add</button>
          </div>
          <ul id="employee-list" class="space-y-2 text-sm"></ul>
        </div>
        <!-- Master Inventory -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">Master Inventory</h3>
            <div>
              <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover mr-2" onclick="app.openModal('addProductModal')">+ Add</button>
              <button class="bg-green-600 text-white px-2 py-1 rounded-md text-sm hover:bg-green-700" onclick="app.openModal('delegateStockModal')">Delegate</button>
            </div>
          </div>
          <div id="master-inventory-list" class="space-y-1 text-sm"></div>
        </div>
        <!-- All Tasks -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">All Tasks</h3>
            <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover" onclick="app.openModal('createTaskModal')">+ Create</button>
          </div>
          <ul id="all-tasks-list" class="space-y-2 text-sm"></ul>
        </div>
      </div>
    </div>
    <!-- Accura AI Advisor Panel -->
    <div id="ai-advisor-panel">
      <h2 class="text-xl font-semibold mb-3 text-sepia-text dark:text-text-primary flex items-center justify-between cursor-pointer" onclick="app.togglePanel('ai-advisor')">
        <span><i class="fas fa-brain mr-2 text-sepia-primary dark:text-primary"></i>Accura AI Advisor</span>
        <i id="ai-advisor-toggle-icon" class="fas fa-chevron-down"></i>
      </h2>
      <div id="ai-advisor-content" class="space-y-4">
        <div>
          <label for="ai-employee-select" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary mb-1">Select Employee to Analyze</label>
          <select id="ai-employee-select" class="w-full bg-sepia-bg dark:bg-secondary text-sepia-text dark:text-text-primary border border-sepia-border dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-sepia-primary dark:focus:ring-primary focus:outline-none"></select>
        </div>
        <button id="generate-plan-btn" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover flex items-center justify-center" onclick="app.generateAIPlan()">
          <span id="generate-plan-text">Generate Plan</span>
          <i id="generate-plan-loader" class="fas fa-spinner fa-spin hidden ml-2"></i>
        </button>
        <div id="ai-plan-output" class="mt-4 p-3 bg-sepia-bg dark:bg-secondary rounded-md text-sm prose max-w-none">
          <p class="text-sepia-text-secondary dark:text-gray-400">Your generated profit improvement plan will appear here.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Employee-Specific Interface -->
  <div id="employee-view" class="flex-grow p-2 md:p-6 overflow-y-auto">
    <div class="mb-6 border-b border-sepia-border dark:border-gray-700">
      <nav class="flex flex-wrap -mb-px" id="tabs-container"></nav>
    </div>
    <div id="tab-content-container">
      <div id="dashboard-content" class="tab-content">...</div>
      <div id="my-tasks-content" class="tab-content hidden">...</div>
      <div id="my-inventory-content" class="tab-content hidden">...</div>
      <div id="sales-expenses-content" class="tab-content hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
          <h2 class="text-2xl font-bold mb-4">Record a Sale</h2>
          <form id="record-sale-form" class="space-y-4" novalidate>
            <div>
              <label for="sale-store" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store</label>
              <select id="sale-store" name="storeId" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
            </div>
            <div>
              <label for="sale-product" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Product</label>
              <select id="sale-product" name="productId" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
            </div>
            <div>
              <label for="sale-quantity" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Quantity</label>
              <input type="number" id="sale-quantity" name="quantity" value="1" min="1" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
            </div>
            <div>
              <label for="sale-type" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Sale Type</label>
              <select id="sale-type" name="saleType" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                <option>Cash</option><option>Credit</option><option>Deal</option>
              </select>
            </div>
            <div>
              <label for="sale-amount" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Final Amount ($)</label>
              <input type="number" id="sale-amount" name="amount" step="0.01" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
            </div>
            <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Record Sale</button>
          </form>
        </div>
        <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
          <h2 class="text-2xl font-bold mb-4">Record an Expense</h2>
          <form id="record-expense-form" class="space-y-4">
             <div>
              <label for="expense-description" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Description</label>
              <input type="text" id="expense-description" name="description" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
            </div>
            <div>
              <label for="expense-amount" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Amount ($)</label>
              <input type="number" id="expense-amount" name="amount" step="0.01" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
            </div>
            <button type="submit" class="w-full bg-sepia-danger text-white py-2 rounded-md hover:bg-red-700 dark:bg-danger">Record Expense</button>
          </form>
        </div>
      </div>
      <div id="invoices-content" class="tab-content hidden">...</div>
      <div id="ledger-content" class="tab-content hidden">...</div>
      <!-- --- ADDED: Stores Tab Content --- -->
      <div id="stores-content" class="tab-content hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Manage Stores</h2>
            <button class="bg-sepia-primary text-white px-4 py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover flex items-center" onclick="app.openModal('addStoreModal')">
                <i class="fas fa-plus mr-2"></i> Add New Store
            </button>
        </div>
        <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow overflow-hidden">
            <table class="min-w-full"><thead class="bg-sepia-bg dark:bg-secondary">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Store Name / Location</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Actions</th>
              </tr>
            </thead><tbody id="stores-tab-list" class="divide-y divide-sepia-border dark:divide-gray-700"></tbody></table>
        </div>
      </div>
    </div>
  </div>
</main>
</div> <div id="toast-container" class="fixed bottom-5 right-5 z-[100] w-80 space-y-2"></div> <!-- Modals --> <div id="modal-container"> <!-- ... Other modals ... --> <div id="addStoreModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"> <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative"> <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('addStoreModal')"><i class="fas fa-times"></i></button> <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Add New Store</h2> <form id="add-store-form"> <div class="mb-4"> <label for="new-store-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store Name / Location</label> <input type="text" id="new-store-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"> </div> <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Add Store</button> </form> </div> </div> <!-- --- ADDED: Assign Stores Modal --- --> <div id="assignStoresModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"> <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative"> <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('assignStoresModal')"><i class="fas fa-times"></i></button> <h2 class="text-2xl font-bold mb-2 text-sepia-text dark:text-text-primary">Assign Stores</h2> <p class="text-sepia-text-secondary dark:text-text-secondary mb-6">Select stores for <strong id="assign-stores-employee-name"></strong></p> <form id="assign-stores-form"> <div id="assign-stores-checklist" class="space-y-2 max-h-60 overflow-y-auto p-2 bg-sepia-bg dark:bg-secondary rounded-md border border-sepia-border dark:border-gray-600 mb-6"> <!-- Checkboxes will be dynamically inserted here --> </div> <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Save Changes</button> </form> </div> </div> <!-- ... Other modals ... --> </div><script> // For brevity, many unchanged functions in the script are omitted from this preview. // The final downloadable file contains the full, working script. document.addEventListener('DOMContentLoaded', () => { const app = { state: { theme: 'dark', currentEmployeeId: null, editingEmployeeId: null, // Added editingEmployeeId employees: [], stores: [], masterInventory: [], tasks: [], }, pdfShiftApiKey: 'YOUR_PDFSHIFT_API_KEY', // Replace with your key init() { /* ... unchanged ... */ }, showFirstTimeSetup() { /* ... unchanged ... */ }, showMainApp() { /* ... unchanged ... */ }, saveState() { /* ... unchanged ... */ }, loadState() { /* ... unchanged ... */ }, getEmployee(id) { return this.state.employees.find(e => e.id === id); }, getProduct(id) { return this.state.masterInventory.find(p => p.id === id); }, getStore(id) { return this.state.stores.find(s => s.id === id); }, addEventListeners() { document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme()); document.getElementById('first-employee-form').addEventListener('submit', (e) => this.handleFirstEmployee(e)); document.getElementById('employee-switcher').addEventListener('change', (e) => { this.state.currentEmployeeId = e.target.value; this.saveState(); this.render(); }); document.getElementById('tabs-container').addEventListener('click', (e) => { const button = e.target.closest('.tab-button'); if (button) this.setActiveTab(button.dataset.tab); }); // Added new form listener document.getElementById('assign-stores-form').addEventListener('submit', e => this.handleAssignStores(e)); // Other form listeners are the same... document.getElementById('add-employee-form').addEventListener('submit', e => this.handleAddEmployee(e)); document.getElementById('add-store-form').addEventListener('submit', e => this.handleAddStore(e)); document.getElementById('add-product-form').addEventListener('submit', e => this.handleAddProduct(e)); document.getElementById('delegate-stock-form').addEventListener('submit', e => this.handleDelegateStock(e)); document.getElementById('create-task-form').addEventListener('submit', e => this.handleCreateTask(e)); document.getElementById('record-sale-form').addEventListener('submit', e => this.handleRecordSale(e)); document.getElementById('record-expense-form').addEventListener('submit', e => this.handleRecordExpense(e)); document.getElementById('invoice-form').addEventListener('submit', e => this.handleGenerateInvoice(e)); }, render() { if (!this.state.employees || this.state.employees.length === 0) { document.getElementById('main-header').classList.add('hidden'); document.getElementById('main-content').classList.add('hidden'); return this.showFirstTimeSetup(); } this.renderEmployeeSwitcher(); this.renderCompanyOverview(); this.renderAIAdvisorPanel(); if (this.state.currentEmployeeId) { this.renderTabs(); this.setActiveTab('dashboard'); } }, renderEmployeeSwitcher() { /* ... unchanged ... */ }, // --- CHANGED: Added store assignment icon to employee list --- renderCompanyOverview() { const employeeList = document.getElementById('employee-list'); employeeList.innerHTML = this.state.employees.map(emp => ` <li class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-2 rounded"> <div> <span class="text-sepia-text dark:text-text-primary">${emp.name}</span> <em class="text-sepia-text-secondary dark:text-gray-400 text-xs">(${emp.position})</em> </div> <div> <i class="fas fa-store action-icon" onclick="app.openAssignStoresModal('${emp.id}')" title="Assign Stores"></i> <i class="fas fa-trash action-icon danger" onclick="app.handleDelete('employee', '${emp.id}')" title="Delete Employee"></i> </div> </li> `).join('') || `<p class="text-xs text-sepia-text-secondary dark:text-gray-400">No employees yet.</p>`; const inventoryList = document.getElementById('master-inventory-list'); inventoryList.innerHTML = this.state.masterInventory.map(prod => ` <div class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-2 rounded"> <span>${prod.name}</span> <div class="flex items-center"> <span class="font-mono text-xs bg-sepia-border dark:bg-gray-700 px-2 py-1 rounded">${prod.stock}</span> <i class="fas fa-trash action-icon danger" onclick="app.handleDelete('product', '${prod.id}')" title="Delete Product"></i> </div> </div> `).join('') || `<p class="text-xs text-sepia-text-secondary dark:text-gray-400">No products yet.</p>`; const allTasksList = document.getElementById('all-tasks-list'); // ... task list rendering unchanged ... }, renderAIAdvisorPanel() { /* ... unchanged ... */ }, // --- CHANGED: Added 'Stores' tab --- renderTabs() { const tabs = [ { id: 'dashboard', name: 'Dashboard', icon: 'fa-chart-line' }, { id: 'my-tasks', name: 'My Tasks', icon: 'fa-tasks' }, { id: 'my-inventory', name: 'My Inventory', icon: 'fa-boxes' }, { id: 'stores', name: 'Stores', icon: 'fa-store' }, { id: 'sales-expenses', name: 'Sales & Expenses', icon: 'fa-exchange-alt' }, { id: 'invoices', name: 'Invoices', icon: 'fa-file-invoice-dollar' }, { id: 'ledger', name: 'Ledger', icon: 'fa-history' }, ]; // ... rest of function unchanged const tabsContainer = document.getElementById('tabs-container'); tabsContainer.innerHTML = tabs.map(tab => `<button data-tab="${tab.id}" class="tab-button text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary hover:bg-sepia-surface dark:hover:bg-secondary py-3 px-4 font-medium text-sm rounded-t-lg"><i class="fas ${tab.icon} mr-2 hidden md:inline"></i>${tab.name}</button>`).join(''); }, renderDashboard() { /* ... unchanged, but an empty div is needed in HTML to avoid errors */ }, renderMyTasks() { /* ... unchanged, but an empty div is needed in HTML to avoid errors */ }, renderMyInventory() { /* ... unchanged, but an empty div is needed in HTML to avoid errors */ }, renderInvoices() { /* ... unchanged, but an empty div is needed in HTML to avoid errors */ }, renderLedger() { /* ... unchanged, but an empty div is needed in HTML to avoid errors */ }, // --- ADDED: Renders the new dedicated Stores tab --- renderStoresTab() { const listEl = document.getElementById('stores-tab-list'); if (!this.state.stores || this.state.stores.length === 0) { listEl.innerHTML = `<tr><td colspan="2" class="px-6 py-4 text-center text-sepia-text-secondary dark:text-gray-400">No stores created yet. Click 'Add New Store' to begin.</td></tr>`; return; } listEl.innerHTML = this.state.stores.map(store => ` <tr class="hover:bg-sepia-bg dark:hover:bg-secondary"> <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${store.name}</td> <td class="px-6 py-4 whitespace-nowrap text-sm"> <i class="fas fa-trash action-icon danger" onclick="app.handleDelete('store', '${store.id}')" title="Delete Store"></i> </td> </tr> `).join(''); }, // --- CHANGED: Sales form now populates based on employee's assigned stores --- renderSalesAndExpenses() { const employee = this.getEmployee(this.state.currentEmployeeId); const saleStoreSelect = document.getElementById('sale-store'); const accessibleStores = this.state.stores.filter(store => (employee.storeAccess && employee.storeAccess.includes(store.id)) ); if (accessibleStores.length === 0) { saleStoreSelect.innerHTML = `<option disabled selected>No stores assigned to you</option>`; saleStoreSelect.disabled = true; } else { saleStoreSelect.innerHTML = accessibleStores.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); saleStoreSelect.disabled = false; } const saleProductSelect = document.getElementById('sale-product'); // ... product selec logic is unchanged if (!employee || !employee.inventory || employee.inventory.length === 0) { saleProductSelect.innerHTML = `<option disabled selected>No inventory to sell</option>`; saleProductSelect.disabled = true; } else { saleProductSelect.innerHTML = employee.inventory .filter(item => item.stock > 0) .map(item => { const product = this.getProduct(item.productId); return `<option value="${product.id}">${product.name} (Stock: ${item.stock})</option>`; }).join(''); saleProductSelect.disabled = saleProductSelect.innerHTML === ''; } const canSell = accessibleStores.length > 0 && employee?.inventory?.some(i => i.stock > 0); document.querySelector('#record-sale-form button').disabled = !canSell; }, // --- CHANGED: Logic for switching tabs --- setActiveTab(tabName) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active')); const contentEl = document.getElementById(`${tabName}-content`); if (contentEl) contentEl.classList.remove('hidden'); const buttonEl = document.querySelector(`[data-tab="${tabName}"]`); if (buttonEl) buttonEl.classList.add('active'); switch(tabName) { case 'dashboard': this.renderDashboard(); break; case 'my-tasks': this.renderMyTasks(); break; case 'my-inventory': this.renderMyInventory(); break; case 'stores': this.renderStoresTab(); break; // Added case 'sales-expenses': this.renderSalesAndExpenses(); break; case 'invoices': this.renderInvoices(); break; case 'ledger': this.renderLedger(); break; } }, openModal(modalId, data) { // Changed to accept data if (modalId === 'assignStoresModal') { return this.openAssignStoresModal(data); } // ... other modal logic const modal = document.getElementById(modalId); if (!modal) return; modal.classList.remove('hidden'); }, // --- ADDED: Modal opener for assigning stores --- openAssignStoresModal(employeeId) { this.state.editingEmployeeId = employeeId; const employee = this.getEmployee(employeeId); if (!employee) return; document.getElementById('assign-stores-employee-name').textContent = employee.name; const checklist = document.getElementById('assign-stores-checklist'); if (this.state.stores.length === 0) { checklist.innerHTML = `<p class="text-sepia-text-secondary dark:text-gray-400 p-2">No stores have been created yet. Please add a store first.</p>`; } else { checklist.innerHTML = this.state.stores.map(store => ` <label class="flex items-center space-x-3 p-2 bg-sepia-surface dark:bg-gray-700 rounded-md hover:bg-sepia-border dark:hover:bg-gray-600 cursor-pointer"> <input type="checkbox" name="store-access" value="${store.id}" class="form-checkbox h-5 w-5 text-sepia-primary dark:text-primary bg-sepia-bg dark:bg-secondary border-sepia-border dark:border-gray-600 rounded focus:ring-sepia-primary" ${(employee.storeAccess && employee.storeAccess.includes(store.id)) ? 'checked' : ''}> <span class="text-sm text-sepia-text dark:text-text-primary">${store.name}</span> </label> `).join(''); } document.getElementById('assignStoresModal').classList.remove('hidden'); }, closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); if (modalId === 'assignStoresModal') { this.state.editingEmployeeId = null; // Clean up } }, togglePanel(panelName) { /* ... unchanged ... */ }, showToast(message, type = 'info', duration = 3000) { /* ... unchanged ... */ }, // --- ACTION HANDLERS --- // --- CHANGED: Employee object now includes storeAccess --- createEmployee(name, position) { return { id: `emp_${Date.now()}`, name, position, inventory: [], transactions: [], storeAccess: [] // Added this property }; }, handleFirstEmployee(e) { /* ... unchanged, but uses new createEmployee */ }, handleAddEmployee(e) { /* ... unchanged, but uses new createEmployee */ }, handleAddStore(e) { e.preventDefault(); const form = e.target; const name = form.querySelector('#new-store-name').value; if (!name) return; this.state.stores.push({ id: `store_${Date.now()}`, name }); this.saveState(); this.setActiveTab('stores'); this.renderStoresTab(); form.reset(); this.closeModal('addStoreModal'); this.showToast('Store added successfully.', 'success'); }, handleAddProduct(e) { /* ... unchanged ... */ }, handleDelegateStock(e) { /* ... unchanged ... */ }, handleCreateTask(e) { /* ... unchanged ... */ }, toggleTaskStatus(taskId) { /* ... unchanged ... */ }, // --- ADDED: Handler for saving store assignments --- handleAssignStores(e) { e.preventDefault(); const employeeId = this.state.editingEmployeeId; if (!employeeId) return; const employee = this.getEmployee(employeeId); const selectedStoreIds = Array.from(e.target.querySelectorAll('input[name="store-access"]:checked')).map(cb => cb.value); employee.storeAccess = selectedStoreIds; this.saveState(); this.closeModal('assignStoresModal'); this.showToast('Store access updated successfully!', 'success'); this.render(); // Re-render in case the current user was the one being edited }, // --- CHANGED: Delete logic now cleans up storeAccess array --- handleDelete(itemType, itemId) { const itemName = this.getItemNameForConfirmation(itemType, itemId); if (!confirm(`Are you sure you want to delete "${itemName}"? This can have cascading effects and cannot be undone.`)) { return; } switch (itemType) { case 'employee': // ... no change break; case 'store': this.state.stores = this.state.stores.filter(s => s.id !== itemId); // Important: Remove this store's ID from any employee who had access to it. this.state.employees.forEach(emp => { if (emp.storeAccess) { emp.storeAccess = emp.storeAccess.filter(storeId => storeId !== itemId); } }); break; case 'product': // ... no change break; } this.saveState(); this.render(); if(itemType === 'store') this.setActiveTab('stores'); this.showToast(`${itemType.charAt(0).toUpperCase() + itemType.slice(1)} deleted.`, 'success'); }, getItemNameForConfirmation(itemType, itemId) { /* ... unchanged ... */ }, handleRecordSale(e) { /* ... unchanged ... */ }, handleRecordExpense(e) { /* ... unchanged ... */ }, handleGenerateInvoice(e) { /* ... unchanged ... */ }, generateInvoiceHtml(employee, sales, total) { /* ... unchanged ... */ }, generateAIPlan() { /* ... unchanged ... */ }, mockGeminiAPI(name, revenue, expenses, profit, transactions) { /* ... unchanged ... */ }, simpleMarkdownToHtml(md) { /* ... unchanged ... */ } }; app.init(); window.app = app; }); </script></body> </html>
AI
Thoughts
Expand to show model's summarized thoughts
To implement the store management features, including a dedicated "Stores" tab, the ability to add new stores, assign stores to employees, and filter sales operations based on employee store access, I've made the following changes:

Added stores property to app.state: An empty array stores: [] to hold store objects.
Updated Employee Data Structure: In the createEmployee function, each new employee object is now initialized with a storeAccess: [] array, which will store the IDs of the stores they have access to.
New "Stores" Tab UI and Logic:
Modified renderTabs to include a new tab labeled "Stores" with a fa-store icon.
Created a new <div> in the HTML for id="stores-content" to house the store management UI.
Implemented renderStoresTab(): This function generates a table listing all added stores, along with a delete button for each. It's called when the "Stores" tab is activated.
Added a "Add New Store" button in the stores-content area that opens the addStoreModal.
"Add New Store" Modal (addStoreModal):
Created the HTML structure for addStoreModal (it was mostly provided, just needed to ensure it was correct).
Implemented handleAddStore(e): This function handles the form submission, creates a new store object with a unique ID, adds it to app.state.stores, saves the state, and re-renders the stores tab.
"Assign Stores to Employee" Feature:
UI Integration: In renderCompanyOverview, an fa-store icon (for "Assign Stores") has been added next to each employee in the "Company Overview" panel. Clicking this icon triggers app.openAssignStoresModal(employee.id).
editingEmployeeId: Added this new state variable app.state.editingEmployeeId to temporarily store the ID of the employee whose stores are being assigned.
New "Assign Stores" Modal (assignStoresModal):
Created the HTML structure for this modal.
Implemented openAssignStoresModal(employeeId): This function populates the modal with the employee's name and a checklist of all available stores. Checkboxes are pre-checked if the employee already has access to that store.
Implemented handleAssignStores(e): This function reads the selected checkboxes, updates the storeAccess array for the editingEmployeeId, saves the state, and closes the modal.
Sales & Expenses Tab Update:
Modified renderSalesAndExpenses(): The "Store" dropdown (sale-store) now dynamically populates with only those stores that the currently selected employee (app.state.currentEmployeeId) has access to (based on their storeAccess array). If an employee has no stores assigned, the dropdown will indicate this and be disabled
Delete Store Functionality:
Updated handleDelete(itemType, itemId): Added a case 'store' that filters out the deleted store from app.state.stores. Crucially, it also iterates through app.state.employees and removes the deleted store's ID from any employee's storeAccess array to maintain data integrity.
These changes integrate a robust store management system into the application, ensuring that an employee's access to stores is configurable and reflected in relevant parts of the UI, such as the sales form.

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ledgerly - Business Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'primary': '#4f46e5', 'primary-hover': '#4338ca', 'secondary': '#1f2937', 'secondary-hover': '#374151',
            'background': '#111827', 'surface': '#1f2937', 'text-primary': '#f9fafb', 'text-secondary': '#d1d5db',
            'accent': '#34d399', 'danger': '#ef4444',
            'sepia-bg': '#fdf6e3', 'sepia-surface': '#fbf1c7', 'sepia-text': '#654321', 'sepia-text-secondary': '#8b5e34',
            'sepia-primary': '#a16207', 'sepia-primary-hover': '#854d0e', 'sepia-border': '#d7c095',
            'sepia-accent': '#16a34a', 'sepia-danger': '#dc2626',
          },
        }
      }
    }
  </script>
  <style>
    body { background-color: #fdf6e3; color: #654321; }
    .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
    .tab-button.active { background-color: #a16207; color: white; }
    .task-completed { text-decoration: line-through; color: #a3a3a3; }
    .prose { color: #654321; }
    .dark body { background-color: #111827; color: #f9fafb; }
    .dark .tab-button.active { background-color: #4f46e5; }
    .dark .prose { color: #f9fafb; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #fbf1c7; }
    .dark ::-webkit-scrollbar-track { background: #1f2937; }
    ::-webkit-scrollbar-thumb { background: #d7c095; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
    ::-webkit-scrollbar-thumb:hover { background: #8b5e34; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #718096; }
    .toast { padding: 1rem; border-radius: 0.5rem; color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); transform: translateX(120%); transition: transform 0.3s ease-in-out; opacity: 0; }
    .toast.show { transform: translateX(0); opacity: 1; }
    .toast.success { background-color: #16a34a; } .toast.danger { background-color: #dc2626; } .toast.info { background-color: #2563eb; }
    .action-icon { cursor: pointer; margin-left: 0.75rem; color: #8b5e34; font-size: 0.9rem; }
    .dark .action-icon { color: #9ca3af; }
    .action-icon.danger:hover { color: #dc2626; } .dark .action-icon.danger:hover { color: #ef4444; }
    .action-icon:hover { color: #654321; } .dark .action-icon:hover { color: #f9fafb; }
  </style>
</head>
<body class="antialiased font-sans">

  <div id="app" class="h-screen flex flex-col">
    <!-- Header -->
    <header id="main-header" class="bg-sepia-surface dark:bg-surface shadow-md p-4 flex justify-between items-center z-20 flex-shrink-0 hidden">
      <div class="flex items-center space-x-4">
        <i class="fas fa-book-open text-sepia-primary dark:text-primary text-2xl"></i>
        <h1 class="text-2xl font-bold text-sepia-text dark:text-text-primary">Ledgerly</h1>
        <button id="theme-toggle" class="text-sepia-text dark:text-text-primary text-xl px-2 py-1 rounded-md hover:bg-sepia-border dark:hover:bg-secondary"><i id="theme-icon" class="fas"></i></button>
      </div>
      <div class="flex items-center space-x-4">
        <span class="text-sepia-text-secondary dark:text-text-secondary hidden md:inline">Current Employee:</span>
        <select id="employee-switcher" class="bg-sepia-bg dark:bg-secondary text-sepia-text dark:text-text-primary border border-sepia-border dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-sepia-primary dark:focus:ring-primary focus:outline-none"></select>
      </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="flex-grow flex flex-col md:flex-row overflow-hidden hidden">
      <!-- Left Panels -->
      <div class="w-full md:w-1/3 lg:w-1/4 bg-sepia-surface dark:bg-surface p-4 overflow-y-auto flex-shrink-0 border-r border-sepia-border dark:border-gray-700">
        <!-- Company Overview Panel -->
        <div id="company-overview-panel" class="mb-6">
          <h2 class="text-xl font-semibold mb-3 text-sepia-text dark:text-text-primary flex items-center justify-between cursor-pointer" onclick="app.togglePanel('company-overview')">
            <span><i class="fas fa-building mr-2 text-sepia-primary dark:text-primary"></i>Company Overview</span>
            <i id="company-overview-toggle-icon" class="fas fa-chevron-down"></i>
          </h2>
          <div id="company-overview-content" class="space-y-4">
            <!-- Employees -->
            <div>
              <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">Employees</h3>
                <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover" onclick="app.openModal('addEmployeeModal')">+ Add</button>
              </div>
              <ul id="employee-list" class="space-y-2 text-sm"></ul>
            </div>
            <!-- Master Inventory -->
            <div>
              <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">Master Inventory</h3>
                <div>
                  <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover mr-2" onclick="app.openModal('addProductModal')">+ Add</button>
                  <button class="bg-green-600 text-white px-2 py-1 rounded-md text-sm hover:bg-green-700" onclick="app.openModal('delegateStockModal')">Delegate</button>
                </div>
              </div>
              <div id="master-inventory-list" class="space-y-1 text-sm"></div>
            </div>
            <!-- All Tasks -->
            <div>
              <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-sepia-text-secondary dark:text-text-secondary">All Tasks</h3>
                <button class="bg-sepia-primary text-white px-2 py-1 rounded-md text-sm hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover" onclick="app.openModal('createTaskModal')">+ Create</button>
              </div>
              <ul id="all-tasks-list" class="space-y-2 text-sm"></ul>
            </div>
          </div>
        </div>
        <!-- Accura AI Advisor Panel -->
        <div id="ai-advisor-panel">
          <h2 class="text-xl font-semibold mb-3 text-sepia-text dark:text-text-primary flex items-center justify-between cursor-pointer" onclick="app.togglePanel('ai-advisor')">
            <span><i class="fas fa-brain mr-2 text-sepia-primary dark:text-primary"></i>Accura AI Advisor</span>
            <i id="ai-advisor-toggle-icon" class="fas fa-chevron-down"></i>
          </h2>
          <div id="ai-advisor-content" class="space-y-4">
            <div>
              <label for="ai-employee-select" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary mb-1">Select Employee to Analyze</label>
              <select id="ai-employee-select" class="w-full bg-sepia-bg dark:bg-secondary text-sepia-text dark:text-text-primary border border-sepia-border dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-sepia-primary dark:focus:ring-primary focus:outline-none"></select>
            </div>
            <button id="generate-plan-btn" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover flex items-center justify-center" onclick="app.generateAIPlan()">
              <span id="generate-plan-text">Generate Plan</span>
              <i id="generate-plan-loader" class="fas fa-spinner fa-spin hidden ml-2"></i>
            </button>
            <div id="ai-plan-output" class="mt-4 p-3 bg-sepia-bg dark:bg-secondary rounded-md text-sm prose max-w-none">
              <p class="text-sepia-text-secondary dark:text-gray-400">Your generated profit improvement plan will appear here.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Employee-Specific Interface -->
      <div id="employee-view" class="flex-grow p-2 md:p-6 overflow-y-auto">
        <div class="mb-6 border-b border-sepia-border dark:border-gray-700">
          <nav class="flex flex-wrap -mb-px" id="tabs-container"></nav>
        </div>
        <div id="tab-content-container">
          <div id="dashboard-content" class="tab-content"></div>
          <div id="my-tasks-content" class="tab-content hidden"></div>
          <div id="my-inventory-content" class="tab-content hidden"></div>
          <div id="sales-expenses-content" class="tab-content hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
              <h2 class="text-2xl font-bold mb-4">Record a Sale</h2>
              <form id="record-sale-form" class="space-y-4" novalidate>
                <div>
                  <label for="sale-store" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store</label>
                  <select id="sale-store" name="storeId" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
                </div>
                <div>
                  <label for="sale-product" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Product</label>
                  <select id="sale-product" name="productId" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary"></select>
                </div>
                <div>
                  <label for="sale-quantity" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Quantity</label>
                  <input type="number" id="sale-quantity" name="quantity" value="1" min="1" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                </div>
                <div>
                  <label for="sale-type" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Sale Type</label>
                  <select id="sale-type" name="saleType" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                    <option>Cash</option><option>Credit</option><option>Deal</option>
                  </select>
                </div>
                <div>
                  <label for="sale-amount" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Final Amount ($)</label>
                  <input type="number" id="sale-amount" name="amount" step="0.01" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                </div>
                <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Record Sale</button>
              </form>
            </div>
            <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
              <h2 class="text-2xl font-bold mb-4">Record an Expense</h2>
              <form id="record-expense-form" class="space-y-4">
                 <div>
                  <label for="expense-description" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Description</label>
                  <input type="text" id="expense-description" name="description" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                </div>
                <div>
                  <label for="expense-amount" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Amount ($)</label>
                  <input type="number" id="expense-amount" name="amount" step="0.01" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
                </div>
                <button type="submit" class="w-full bg-sepia-danger text-white py-2 rounded-md hover:bg-red-700 dark:bg-danger">Record Expense</button>
              </form>
            </div>
          </div>
          <div id="invoices-content" class="tab-content hidden"></div>
          <div id="ledger-content" class="tab-content hidden"></div>
          
          <!-- Stores Tab Content -->
          <div id="stores-content" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Manage Stores</h2>
                <button class="bg-sepia-primary text-white px-4 py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover flex items-center" onclick="app.openModal('addStoreModal')">
                    <i class="fas fa-plus mr-2"></i> Add New Store
                </button>
            </div>
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-sepia-bg dark:bg-secondary">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Store Name / Location</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stores-tab-list" class="divide-y divide-sepia-border dark:divide-gray-700">
                    </tbody>
                </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="toast-container" class="fixed bottom-5 right-5 z-[100] w-80 space-y-2"></div>

  <!-- Modals -->
  <div id="modal-container">
    <!-- First Time Setup Modal -->
    <div id="firstTimeSetupModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
      <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Welcome to Ledgerly!</h2>
        <p class="text-sepia-text-secondary dark:text-text-secondary mb-4">Let's get you set up with your first employee.</p>
        <form id="first-employee-form">
          <div class="mb-4">
            <label for="first-employee-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Your Name</label>
            <input type="text" id="first-employee-name" placeholder="John Doe" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <div class="mb-6">
            <label for="first-employee-position" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Your Position</label>
            <input type="text" id="first-employee-position" placeholder="Manager" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Get Started</button>
        </form>
      </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="addEmployeeModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
      <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
        <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('addEmployeeModal')"><i class="fas fa-times"></i></button>
        <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Add New Employee</h2>
        <form id="add-employee-form">
          <div class="mb-4">
            <label for="new-employee-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Employee Name</label>
            <input type="text" id="new-employee-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <div class="mb-6">
            <label for="new-employee-position" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Position</label>
            <input type="text" id="new-employee-position" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Add Employee</button>
        </form>
      </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
      <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
        <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('addProductModal')"><i class="fas fa-times"></i></button>
        <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Add New Product to Master Inventory</h2>
        <form id="add-product-form">
          <div class="mb-4">
            <label for="new-product-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Product Name</label>
            <input type="text" id="new-product-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <div class="mb-4">
            <label for="new-product-price" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Price ($)</label>
            <input type="number" id="new-product-price" step="0.01" required value="10.00" class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <div class="mb-6">
            <label for="new-product-stock" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Initial Stock</label>
            <input type="number" id="new-product-stock" min="0" required value="0" class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Add Product</button>
        </form>
      </div>
    </div>

    <!-- Delegate Stock Modal -->
    <div id="delegateStockModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
      <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
        <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('delegateStockModal')"><i class="fas fa-times"></i></button>
        <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Delegate Stock to Employee</h2>
        <form id="delegate-stock-form">
          <div class="mb-4">
            <label for="delegate-employee-select" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Select Employee</label>
            <select id="delegate-employee-select" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
            </select>
          </div>
          <div class="mb-4">
            <label for="delegate-product-select" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Select Product</label>
            <select id="delegate-product-select" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
            </select>
          </div>
          <div class="mb-6">
            <label for="delegate-quantity" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Quantity to Delegate</label>
            <input type="number" id="delegate-quantity" min="1" required value="1" class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Delegate Stock</button>
        </form>
      </div>
    </div>

    <!-- Create Task Modal -->
    <div id="createTaskModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
      <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
        <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('createTaskModal')"><i class="fas fa-times"></i></button>
        <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Create New Task</h2>
        <form id="create-task-form">
          <div class="mb-4">
            <label for="task-description" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Task Description</label>
            <input type="text" id="task-description" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <div class="mb-6">
            <label for="task-assignee-select" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Assign To</label>
            <select id="task-assignee-select" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
            </select>
          </div>
          <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Create Task</button>
        </form>
      </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
      <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-3xl relative">
        <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('invoiceModal')"><i class="fas fa-times"></i></button>
        <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Invoice Preview</h2>
        <div id="invoice-preview" class="max-h-[70vh] overflow-y-auto border border-sepia-border dark:border-gray-600 p-4 rounded-md bg-sepia-bg dark:bg-secondary text-sepia-text dark:text-text-primary">
          <!-- Invoice content will be loaded here -->
        </div>
        <div class="mt-6 flex justify-end space-x-3">
          <button class="bg-gray-400 text-white py-2 px-4 rounded-md hover:bg-gray-500" onclick="app.closeModal('invoiceModal')">Close</button>
          <button id="download-invoice-btn" class="bg-sepia-primary text-white py-2 px-4 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Download PDF</button>
        </div>
      </div>
    </div>

    <!-- Add Store Modal -->
    <div id="addStoreModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
      <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
        <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('addStoreModal')"><i class="fas fa-times"></i></button>
        <h2 class="text-2xl font-bold mb-6 text-sepia-text dark:text-text-primary">Add New Store</h2>
        <form id="add-store-form">
          <div class="mb-4">
            <label for="new-store-name" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Store Name / Location</label>
            <input type="text" id="new-store-name" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Add Store</button>
        </form>
      </div>
    </div>

    <!-- Assign Stores Modal -->
    <div id="assignStoresModal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
      <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow-xl p-8 w-full max-w-md relative">
        <button class="absolute top-4 right-4 text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary" onclick="app.closeModal('assignStoresModal')"><i class="fas fa-times"></i></button>
        <h2 class="text-2xl font-bold mb-2 text-sepia-text dark:text-text-primary">Assign Stores</h2>
        <p class="text-sepia-text-secondary dark:text-text-secondary mb-6">Select stores for <strong id="assign-stores-employee-name"></strong></p>
        <form id="assign-stores-form">
            <div id="assign-stores-checklist" class="space-y-2 max-h-60 overflow-y-auto p-2 bg-sepia-bg dark:bg-secondary rounded-md border border-sepia-border dark:border-gray-600 mb-6">
                <!-- Checkboxes will be dynamically inserted here -->
            </div>
          <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
 
<script>
document.addEventListener('DOMContentLoaded', () => {
  const app = {
    state: {
      theme: 'dark', 
      currentEmployeeId: null, 
      editingEmployeeId: null, // Added for assign stores feature
      employees: [], 
      stores: [], // New state property for stores
      masterInventory: [], 
      tasks: [],
    },
    pdfShiftApiKey: 'YOUR_PDFSHIFT_API_KEY', // Replace with your key

    init() {
      this.loadState();
      this.applyTheme(this.state.theme);
      this.addEventListeners();
      this.render();
    },

    showFirstTimeSetup() {
      document.getElementById('firstTimeSetupModal').classList.remove('hidden');
      // Hide main app elements
      document.getElementById('main-header').classList.add('hidden');
      document.getElementById('main-content').classList.add('hidden');
    },

    showMainApp() {
      document.getElementById('firstTimeSetupModal').classList.add('hidden');
      // Show main app elements
      document.getElementById('main-header').classList.remove('hidden');
      document.getElementById('main-content').classList.remove('hidden');
    },

    saveState() {
      localStorage.setItem('ledgerlyState', JSON.stringify(this.state));
    },

    loadState() {
      const storedState = localStorage.getItem('ledgerlyState');
      if (storedState) {
        this.state = JSON.parse(storedState);
        // Ensure new properties exist if loading from old state
        this.state.employees = this.state.employees || [];
        this.state.employees.forEach(emp => {
            emp.storeAccess = emp.storeAccess || [];
        });
        this.state.stores = this.state.stores || [];
        this.state.masterInventory = this.state.masterInventory || [];
        this.state.tasks = this.state.tasks || [];

        // Set current employee if they exist, otherwise pick first
        if (this.state.currentEmployeeId && this.getEmployee(this.state.currentEmployeeId)) {
          // Valid ID
        } else if (this.state.employees.length > 0) {
          this.state.currentEmployeeId = this.state.employees[0].id;
        } else {
          this.state.currentEmployeeId = null;
        }
      } else {
        this.state.theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        this.state.employees = [];
        this.state.stores = [];
      }
    },

    getEmployee(id) { return this.state.employees.find(e => e.id === id); },
    getProduct(id) { return this.state.masterInventory.find(p => p.id === id); },
    getStore(id) { return this.state.stores.find(s => s.id === id); },

    addEventListeners() {
      document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
      document.getElementById('first-employee-form').addEventListener('submit', (e) => this.handleFirstEmployee(e));
      document.getElementById('employee-switcher').addEventListener('change', (e) => {
        this.state.currentEmployeeId = e.target.value; this.saveState(); this.render();
      });
      document.getElementById('tabs-container').addEventListener('click', (e) => {
        const button = e.target.closest('.tab-button');
        if (button) this.setActiveTab(button.dataset.tab);
      });
      
      document.getElementById('add-employee-form').addEventListener('submit', e => this.handleAddEmployee(e));
      document.getElementById('add-store-form').addEventListener('submit', e => this.handleAddStore(e)); // New
      document.getElementById('assign-stores-form').addEventListener('submit', e => this.handleAssignStores(e)); // New
      document.getElementById('add-product-form').addEventListener('submit', e => this.handleAddProduct(e));
      document.getElementById('delegate-stock-form').addEventListener('submit', e => this.handleDelegateStock(e));
      document.getElementById('create-task-form').addEventListener('submit', e => this.handleCreateTask(e));
      document.getElementById('record-sale-form').addEventListener('submit', e => this.handleRecordSale(e));
      document.getElementById('record-expense-form').addEventListener('submit', e => this.handleRecordExpense(e));
      document.getElementById('invoice-form').addEventListener('submit', e => this.handleGenerateInvoice(e));
      document.getElementById('download-invoice-btn').addEventListener('click', () => this.downloadInvoicePdf());

    },

    render() {
      if (!this.state.employees || this.state.employees.length === 0) {
        return this.showFirstTimeSetup();
      }
      this.showMainApp();
      this.renderEmployeeSwitcher();
      this.renderCompanyOverview();
      this.renderAIAdvisorPanel();
      if (this.state.currentEmployeeId) {
        this.renderTabs();
        this.setActiveTab(this.currentTab || 'dashboard'); // Retain active tab or default to dashboard
      }
    },

    renderEmployeeSwitcher() {
      const switcher = document.getElementById('employee-switcher');
      switcher.innerHTML = '';
      this.state.employees.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.id;
        option.textContent = emp.name;
        if (emp.id === this.state.currentEmployeeId) {
          option.selected = true;
        }
        switcher.appendChild(option);
      });
    },

    renderCompanyOverview() {
        const employeeList = document.getElementById('employee-list');
        employeeList.innerHTML = this.state.employees.map(emp => `
            <li class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-2 rounded">
            <div>
                <span class="text-sepia-text dark:text-text-primary">${emp.name}</span>
                <em class="text-sepia-text-secondary dark:text-gray-400 text-xs">(${emp.position})</em>
            </div>
            <div>
                <i class="fas fa-store action-icon" onclick="app.openAssignStoresModal('${emp.id}')" title="Assign Stores"></i>
                <i class="fas fa-trash action-icon danger" onclick="app.handleDelete('employee', '${emp.id}')" title="Delete Employee"></i>
            </div>
            </li>
        `).join('') || `<p class="text-xs text-sepia-text-secondary dark:text-gray-400">No employees yet.</p>`;

        const inventoryList = document.getElementById('master-inventory-list');
        inventoryList.innerHTML = this.state.masterInventory.map(prod => `
            <div class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-2 rounded">
            <span>${prod.name}</span>
            <div class="flex items-center">
                <span class="font-mono text-xs bg-sepia-border dark:bg-gray-700 px-2 py-1 rounded">${prod.stock}</span>
                <i class="fas fa-trash action-icon danger" onclick="app.handleDelete('product', '${prod.id}')" title="Delete Product"></i>
            </div>
            </div>
        `).join('') || `<p class="text-xs text-sepia-text-secondary dark:text-gray-400">No products yet.</p>`;
        
        const allTasksList = document.getElementById('all-tasks-list');
        const allTasks = [...this.state.tasks].sort((a,b) => a.completed - b.completed || new Date(a.id.split('_')[1]) - new Date(b.id.split('_')[1]));
        allTasksList.innerHTML = allTasks.map(task => {
            const assignee = this.getEmployee(task.assigneeId);
            const assigneeName = assignee ? assignee.name : 'Unknown';
            const completedClass = task.completed ? 'task-completed' : '';
            return `
                <li class="flex justify-between items-center bg-sepia-bg dark:bg-secondary p-2 rounded ${completedClass}">
                    <span>${task.description} <em class="text-sepia-text-secondary dark:text-gray-400 text-xs">(Assignee: ${assigneeName})</em></span>
                    <div>
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-sepia-primary dark:text-primary rounded" ${task.completed ? 'checked' : ''} onclick="app.toggleTaskStatus('${task.id}')">
                        <i class="fas fa-trash action-icon danger" onclick="app.handleDelete('task', '${task.id}')" title="Delete Task"></i>
                    </div>
                </li>
            `;
        }).join('') || `<p class="text-xs text-sepia-text-secondary dark:text-gray-400">No tasks created yet.</p>`;
    },


    renderAIAdvisorPanel() {
      const aiEmployeeSelect = document.getElementById('ai-employee-select');
      aiEmployeeSelect.innerHTML = this.state.employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
      if (!this.state.employees.length) {
        aiEmployeeSelect.innerHTML = `<option disabled selected>No employees to analyze</option>`;
        document.getElementById('generate-plan-btn').disabled = true;
      } else {
        document.getElementById('generate-plan-btn').disabled = false;
      }
    },
    
    renderTabs() {
      const tabs = [
        { id: 'dashboard', name: 'Dashboard', icon: 'fa-chart-line' },
        { id: 'my-tasks', name: 'My Tasks', icon: 'fa-tasks' },
        { id: 'my-inventory', name: 'My Inventory', icon: 'fa-boxes' },
        { id: 'stores', name: 'Stores', icon: 'fa-store' }, // New tab
        { id: 'sales-expenses', name: 'Sales & Expenses', icon: 'fa-exchange-alt' },
        { id: 'invoices', name: 'Invoices', icon: 'fa-file-invoice-dollar' },
        { id: 'ledger', name: 'Ledger', icon: 'fa-history' },
      ];
      const tabsContainer = document.getElementById('tabs-container');
      tabsContainer.innerHTML = tabs.map(tab => `<button data-tab="${tab.id}" class="tab-button text-sepia-text-secondary dark:text-text-secondary hover:text-sepia-text dark:hover:text-text-primary hover:bg-sepia-surface dark:hover:bg-secondary py-3 px-4 font-medium text-sm rounded-t-lg"><i class="fas ${tab.icon} mr-2 hidden md:inline"></i>${tab.name}</button>`).join('');
    },
    
    renderDashboard() {
      const dashboardContent = document.getElementById('dashboard-content');
      const employee = this.getEmployee(this.state.currentEmployeeId);
      if (!employee) {
        dashboardContent.innerHTML = `<p class="text-sepia-text dark:text-text-primary">Please select an employee.</p>`;
        return;
      }

      const totalSales = employee.transactions
        .filter(t => t.type === 'sale')
        .reduce((sum, t) => sum + t.amount, 0);
      const totalExpenses = employee.transactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
      const profit = totalSales - totalExpenses;
      const profitColor = profit >= 0 ? 'text-sepia-accent dark:text-accent' : 'text-sepia-danger dark:text-danger';

      const employeeTasks = this.state.tasks.filter(task => task.assigneeId === employee.id);
      const completedTasks = employeeTasks.filter(task => task.completed).length;
      const pendingTasks = employeeTasks.length - completedTasks;

      dashboardContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
            <h3 class="text-xl font-bold mb-3 text-sepia-primary dark:text-primary flex items-center"><i class="fas fa-user mr-2"></i> ${employee.name}</h3>
            <p class="text-sepia-text-secondary dark:text-text-secondary">${employee.position}</p>
          </div>
          <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
            <h3 class="text-xl font-bold mb-3 text-sepia-primary dark:text-primary flex items-center"><i class="fas fa-chart-bar mr-2"></i> Financial Summary</h3>
            <p class="text-sepia-text dark:text-text-primary">Total Sales: <span class="font-bold text-sepia-accent dark:text-accent">$${totalSales.toFixed(2)}</span></p>
            <p class="text-sepia-text dark:text-text-primary">Total Expenses: <span class="font-bold text-sepia-danger dark:text-danger">$${totalExpenses.toFixed(2)}</span></p>
            <p class="text-sepia-text dark:text-text-primary">Net Profit: <span class="font-bold ${profitColor}">$${profit.toFixed(2)}</span></p>
          </div>
          <div class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg">
            <h3 class="text-xl font-bold mb-3 text-sepia-primary dark:text-primary flex items-center"><i class="fas fa-tasks mr-2"></i> Task Status</h3>
            <p class="text-sepia-text dark:text-text-primary">Total Assigned: <span class="font-bold">${employeeTasks.length}</span></p>
            <p class="text-sepia-text dark:text-text-primary">Completed: <span class="font-bold text-sepia-accent dark:text-accent">${completedTasks}</span></p>
            <p class="text-sepia-text dark:text-text-primary">Pending: <span class="font-bold text-sepia-danger dark:text-danger">${pendingTasks}</span></p>
          </div>
        </div>
      `;
    },

    renderMyTasks() {
      const myTasksContent = document.getElementById('my-tasks-content');
      const employee = this.getEmployee(this.state.currentEmployeeId);
      if (!employee) {
        myTasksContent.innerHTML = `<p class="text-sepia-text dark:text-text-primary">Please select an employee.</p>`;
        return;
      }
      const myTasks = this.state.tasks.filter(task => task.assigneeId === employee.id).sort((a,b) => a.completed - b.completed || new Date(a.id.split('_')[1]) - new Date(b.id.split('_')[1]));
      myTasksContent.innerHTML = myTasks.length > 0 ? `
        <h2 class="text-2xl font-bold mb-4">My Assigned Tasks</h2>
        <ul class="space-y-3">
          ${myTasks.map(task => `
            <li class="flex justify-between items-center bg-sepia-surface dark:bg-surface p-4 rounded-lg shadow ${task.completed ? 'task-completed' : ''}">
              <span>${task.description}</span>
              <input type="checkbox" class="form-checkbox h-5 w-5 text-sepia-primary dark:text-primary rounded focus:ring-sepia-primary" ${task.completed ? 'checked' : ''} onclick="app.toggleTaskStatus('${task.id}')">
            </li>
          `).join('')}
        </ul>
      ` : `<p class="text-sepia-text dark:text-text-primary">You have no assigned tasks.</p>`;
    },

    renderMyInventory() {
      const myInventoryContent = document.getElementById('my-inventory-content');
      const employee = this.getEmployee(this.state.currentEmployeeId);
      if (!employee) {
        myInventoryContent.innerHTML = `<p class="text-sepia-text dark:text-text-primary">Please select an employee.</p>`;
        return;
      }
      myInventoryContent.innerHTML = employee.inventory && employee.inventory.length > 0 ? `
        <h2 class="text-2xl font-bold mb-4">My Inventory</h2>
        <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow overflow-hidden">
          <table class="min-w-full">
            <thead class="bg-sepia-bg dark:bg-secondary">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Product</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Stock</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Price</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-sepia-border dark:divide-gray-700">
              ${employee.inventory.map(item => {
                const product = this.getProduct(item.productId);
                return `
                  <tr class="hover:bg-sepia-bg dark:hover:bg-secondary">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-sepia-text dark:text-text-primary">${product ? product.name : 'Unknown Product'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${item.stock}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">$${(product ? product.price : 0).toFixed(2)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      ` : `<p class="text-sepia-text dark:text-text-primary">Your inventory is empty.</p>`;
    },

    // New: Renders the dedicated Stores tab
    renderStoresTab() {
        const listEl = document.getElementById('stores-tab-list');
        if (!this.state.stores || this.state.stores.length === 0) {
            listEl.innerHTML = `<tr><td colspan="2" class="px-6 py-4 text-center text-sepia-text-secondary dark:text-gray-400">No stores created yet. Click 'Add New Store' to begin.</td></tr>`;
            return;
        }
        listEl.innerHTML = this.state.stores.map(store => `
            <tr class="hover:bg-sepia-bg dark:hover:bg-secondary">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${store.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <i class="fas fa-trash action-icon danger" onclick="app.handleDelete('store', '${store.id}')" title="Delete Store"></i>
                </td>
            </tr>
        `).join('');
    },

    renderSalesAndExpenses() {
      const employee = this.getEmployee(this.state.currentEmployeeId);
      const saleStoreSelect = document.getElementById('sale-store');
      
      // Filter stores based on employee's storeAccess
      const accessibleStores = this.state.stores.filter(store => 
          (employee.storeAccess && employee.storeAccess.includes(store.id))
      );

      if (accessibleStores.length === 0) {
        saleStoreSelect.innerHTML = `<option disabled selected>No stores assigned to you</option>`;
        saleStoreSelect.disabled = true;
      } else {
        saleStoreSelect.innerHTML = accessibleStores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        saleStoreSelect.disabled = false;
      }
      
      const saleProductSelect = document.getElementById('sale-product');
      if (!employee || !employee.inventory || employee.inventory.length === 0) {
        saleProductSelect.innerHTML = `<option disabled selected>No inventory to sell</option>`;
        saleProductSelect.disabled = true;
      } else {
         saleProductSelect.innerHTML = employee.inventory
          .filter(item => item.stock > 0)
          .map(item => {
            const product = this.getProduct(item.productId);
            // Check if product actually exists
            return product ? `<option value="${product.id}">${product.name} (Stock: ${item.stock})</option>` : '';
          }).join('');
        saleProductSelect.disabled = saleProductSelect.innerHTML === '';
        // If there's an option but no product selected, select the first one
        if(!saleProductSelect.value && saleProductSelect.options.length > 0) {
            saleProductSelect.value = saleProductSelect.options[0].value;
        }
      }

      // Enable/disable the record sale button
      const canSell = accessibleStores.length > 0 && employee?.inventory?.some(i => i.stock > 0);
      document.querySelector('#record-sale-form button[type="submit"]').disabled = !canSell;
      if (!canSell) {
          if (accessibleStores.length === 0) {
              this.showToast("Cannot record sale: No stores assigned to this employee.", "info", 5000);
          } else if (!employee?.inventory?.some(i => i.stock > 0)) {
              this.showToast("Cannot record sale: Employee has no stock.", "info", 5000);
          }
      }
    },

    renderInvoices() {
      const invoicesContent = document.getElementById('invoices-content');
      const employee = this.getEmployee(this.state.currentEmployeeId);
      if (!employee) {
        invoicesContent.innerHTML = `<p class="text-sepia-text dark:text-text-primary">Please select an employee.</p>`;
        return;
      }

      const salesTransactions = employee.transactions.filter(t => t.type === 'sale');
      
      invoicesContent.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">Generate Invoice</h2>
        <form id="invoice-form" class="bg-sepia-surface dark:bg-surface p-6 rounded-lg shadow-lg space-y-4">
          <div>
            <label for="invoice-start-date" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">Start Date</label>
            <input type="date" id="invoice-start-date" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <div>
            <label for="invoice-end-date" class="block text-sm font-medium text-sepia-text-secondary dark:text-text-secondary">End Date</label>
            <input type="date" id="invoice-end-date" required class="mt-1 block w-full bg-sepia-bg dark:bg-secondary border border-sepia-border dark:border-gray-600 rounded-md py-2 px-3 text-sepia-text dark:text-text-primary focus:outline-none focus:ring-sepia-primary dark:focus:ring-primary focus:border-sepia-primary dark:focus:border-primary">
          </div>
          <button type="submit" class="w-full bg-sepia-primary text-white py-2 rounded-md hover:bg-sepia-primary-hover dark:bg-primary dark:hover:bg-primary-hover">Generate Invoice</button>
        </form>
        <div id="invoice-history" class="mt-8">
            <h3 class="text-xl font-bold mb-3">Recent Sales Transactions</h3>
            ${salesTransactions.length > 0 ? `
            <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow overflow-hidden">
                <table class="min-w-full">
                    <thead class="bg-sepia-bg dark:bg-secondary">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Product</th>
                             <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Store</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Qty</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Amount</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-sepia-border dark:divide-gray-700">
                        ${salesTransactions.slice(-10).reverse().map(t => { // Show last 10 sales
                            const product = this.getProduct(t.productId);
                            const store = this.getStore(t.storeId);
                            return `
                                <tr class="hover:bg-sepia-bg dark:hover:bg-secondary">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${new Date(t.date).toLocaleDateString()}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${product ? product.name : 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${store ? store.name : 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${t.quantity}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">$${t.amount.toFixed(2)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            ` : `<p class="text-sepia-text dark:text-text-primary">No sales recorded yet.</p>`}
        </div>
      `;
    },

    renderLedger() {
      const ledgerContent = document.getElementById('ledger-content');
      const employee = this.getEmployee(this.state.currentEmployeeId);
      if (!employee) {
        ledgerContent.innerHTML = `<p class="text-sepia-text dark:text-text-primary">Please select an employee.</p>`;
        return;
      }

      const transactions = [...employee.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

      ledgerContent.innerHTML = transactions.length > 0 ? `
        <h2 class="text-2xl font-bold mb-4">Transaction Ledger</h2>
        <div class="bg-sepia-surface dark:bg-surface rounded-lg shadow overflow-hidden">
          <table class="min-w-full">
            <thead class="bg-sepia-bg dark:bg-secondary">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Type</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Description</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-sepia-text-secondary dark:text-text-secondary uppercase tracking-wider">Amount</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-sepia-border dark:divide-gray-700">
              ${transactions.map(t => {
                let description = '';
                if (t.type === 'sale') {
                  const product = this.getProduct(t.productId);
                  const store = this.getStore(t.storeId);
                  description = `${t.quantity} x ${product ? product.name : 'Unknown Product'} from ${store ? store.name : 'N/A'} (${t.saleType})`;
                } else if (t.type === 'expense') {
                  description = t.description;
                }
                const amountClass = t.type === 'sale' ? 'text-sepia-accent dark:text-accent' : 'text-sepia-danger dark:text-danger';
                const sign = t.type === 'sale' ? '+' : '-';
                return `
                  <tr class="hover:bg-sepia-bg dark:hover:bg-secondary">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${new Date(t.date).toLocaleDateString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary capitalize">${t.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-sepia-text dark:text-text-primary">${description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${amountClass}">${sign}$${t.amount.toFixed(2)}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      ` : `<p class="text-sepia-text dark:text-text-primary">No transactions recorded yet.</p>`;
    },


    setActiveTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
      
      const contentEl = document.getElementById(`${tabName}-content`);
      if (contentEl) contentEl.classList.remove('hidden');
      const buttonEl = document.querySelector(`[data-tab="${tabName}"]`);
      if (buttonEl) buttonEl.classList.add('active');
      
      this.currentTab = tabName; // Store current tab
      
      switch(tabName) {
        case 'dashboard': this.renderDashboard(); break;
        case 'my-tasks': this.renderMyTasks(); break;
        case 'my-inventory': this.renderMyInventory(); break;
        case 'stores': this.renderStoresTab(); break; // New
        case 'sales-expenses': this.renderSalesAndExpenses(); break;
        case 'invoices': this.renderInvoices(); break;
        case 'ledger': this.renderLedger(); break;
      }
    },

    openModal(modalId, data = null) { // Changed to accept data
      if (modalId === 'delegateStockModal') {
        this.populateDelegateStockModal();
      } else if (modalId === 'createTaskModal') {
        this.populateAssigneeSelect();
      } else if (modalId === 'assignStoresModal') { // Handle new assign stores modal
        return this.openAssignStoresModal(data);
      }
      
      const modal = document.getElementById(modalId);
      if (!modal) return;
      modal.classList.remove('hidden');
    },

    // New: Modal opener for assigning stores
    openAssignStoresModal(employeeId) {
        this.state.editingEmployeeId = employeeId;
        const employee = this.getEmployee(employeeId);
        if (!employee) return;

        document.getElementById('assign-stores-employee-name').textContent = employee.name;
        const checklist = document.getElementById('assign-stores-checklist');
        
        if (this.state.stores.length === 0) {
            checklist.innerHTML = `<p class="text-sepia-text-secondary dark:text-gray-400 p-2">No stores have been created yet. Please add a store first.</p>`;
        } else {
            // Sort stores alphabetically by name for consistent display
            const sortedStores = [...this.state.stores].sort((a, b) => a.name.localeCompare(b.name));

            checklist.innerHTML = sortedStores.map(store => `
                <label class="flex items-center space-x-3 p-2 bg-sepia-surface dark:bg-gray-700 rounded-md hover:bg-sepia-border dark:hover:bg-gray-600 cursor-pointer">
                    <input type="checkbox" name="store-access" value="${store.id}" 
                           class="form-checkbox h-5 w-5 text-sepia-primary dark:text-primary bg-sepia-bg dark:bg-secondary border-sepia-border dark:border-gray-600 rounded focus:ring-sepia-primary"
                           ${(employee.storeAccess && employee.storeAccess.includes(store.id)) ? 'checked' : ''}>
                    <span class="text-sm text-sepia-text dark:text-text-primary">${store.name}</span>
                </label>
            `).join('');
        }
        document.getElementById('assignStoresModal').classList.remove('hidden');
    },

    closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
      if (modalId === 'addEmployeeModal') document.getElementById('add-employee-form').reset();
      if (modalId === 'addProductModal') document.getElementById('add-product-form').reset();
      if (modalId === 'createTaskModal') document.getElementById('create-task-form').reset();
      if (modalId === 'addStoreModal') document.getElementById('add-store-form').reset(); // New
      if (modalId === 'assignStoresModal') { // New
          this.state.editingEmployeeId = null; // Clean up
      }
    },
    
    togglePanel(panelName) {
      const content = document.getElementById(`${panelName}-content`);
      const icon = document.getElementById(`${panelName}-toggle-icon`);
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
      } else {
        content.classList.add('hidden');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
      }
    },

    applyTheme(theme) {
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
        document.getElementById('theme-icon').classList.remove('fa-sun');
        document.getElementById('theme-icon').classList.add('fa-moon');
      } else {
        document.documentElement.classList.remove('dark');
        document.getElementById('theme-icon').classList.remove('fa-moon');
        document.getElementById('theme-icon').classList.add('fa-sun');
      }
      this.state.theme = theme;
      this.saveState();
    },

    toggleTheme() {
      this.applyTheme(this.state.theme === 'dark' ? 'light' : 'dark');
    },

    showToast(message, type = 'info', duration = 3000) {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);

      // Trigger reflow to apply initial transform
      void toast.offsetWidth; 
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
      }, duration);
    },
    
    // --- ACTION HANDLERS ---

    createEmployee(name, position) {
      return {
        id: `emp_${Date.now()}`, name, position,
        inventory: [], transactions: [], tasks: [], storeAccess: [] // Added this property
      };
    },

    handleFirstEmployee(e) {
      e.preventDefault();
      const form = e.target;
      const name = form.querySelector('#first-employee-name').value;
      const position = form.querySelector('#first-employee-position').value;
      
      const newEmployee = this.createEmployee(name, position);
      this.state.employees.push(newEmployee);
      this.state.currentEmployeeId = newEmployee.id;
      this.saveState();
      this.render();
      this.showToast(`Welcome, ${name}! Your first employee record is created.`, 'success');
      this.closeModal('firstTimeSetupModal');
    },

    handleAddEmployee(e) {
      e.preventDefault();
      const form = e.target;
      const name = form.querySelector('#new-employee-name').value;
      const position = form.querySelector('#new-employee-position').value;

      const newEmployee = this.createEmployee(name, position);
      this.state.employees.push(newEmployee);
      this.saveState();
      this.render();
      this.closeModal('addEmployeeModal');
      this.showToast('Employee added successfully.', 'success');
    },

    // New: Handle adding a store
    handleAddStore(e) {
      e.preventDefault();
      const form = e.target;
      const name = form.querySelector('#new-store-name').value;
      if (!name) return;

      this.state.stores.push({ id: `store_${Date.now()}`, name });
      this.saveState();
      this.setActiveTab('stores'); // Switch to the new Stores tab
      this.renderStoresTab(); // Re-render the stores list
      form.reset();
      this.closeModal('addStoreModal');
      this.showToast('Store added successfully.', 'success');
    },
    
    handleAddProduct(e) {
        e.preventDefault();
        const form = e.target;
        const name = form.querySelector('#new-product-name').value;
        const price = parseFloat(form.querySelector('#new-product-price').value);
        const stock = parseInt(form.querySelector('#new-product-stock').value, 10);

        if (!name || isNaN(price) || isNaN(stock)) {
            this.showToast('Please fill all product fields correctly.', 'danger');
            return;
        }

        this.state.masterInventory.push({ id: `prod_${Date.now()}`, name, price, stock });
        this.saveState();
        this.renderCompanyOverview(); // Update master inventory list
        form.reset();
        this.closeModal('addProductModal');
        this.showToast('Product added to master inventory.', 'success');
    },

    populateDelegateStockModal() {
      const employeeSelect = document.getElementById('delegate-employee-select');
      employeeSelect.innerHTML = this.state.employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
      
      const productSelect = document.getElementById('delegate-product-select');
      productSelect.innerHTML = this.state.masterInventory
        .filter(p => p.stock > 0) // Only show products with stock
        .map(p => `<option value="${p.id}">${p.name} (Master Stock: ${p.stock})</option>`).join('');

      // Disable if no employees or no products
      employeeSelect.disabled = this.state.employees.length === 0;
      productSelect.disabled = this.state.masterInventory.filter(p => p.stock > 0).length === 0;
      document.querySelector('#delegateStockModal button[type="submit"]').disabled = employeeSelect.disabled || productSelect.disabled;
    },

    handleDelegateStock(e) {
      e.preventDefault();
      const form = e.target;
      const employeeId = form.querySelector('#delegate-employee-select').value;
      const productId = form.querySelector('#delegate-product-select').value;
      const quantity = parseInt(form.querySelector('#delegate-quantity').value, 10);

      const employee = this.getEmployee(employeeId);
      const product = this.getProduct(productId);

      if (!employee || !product || quantity <= 0 || quantity > product.stock) {
        this.showToast('Invalid delegation. Check quantities and selections.', 'danger');
        return;
      }

      // Deduct from master stock
      product.stock -= quantity;

      // Add to employee's inventory
      const employeeProduct = employee.inventory.find(item => item.productId === productId);
      if (employeeProduct) {
        employeeProduct.stock += quantity;
      } else {
        employee.inventory.push({ productId, stock: quantity });
      }

      this.saveState();
      this.render(); // Re-render panels
      this.closeModal('delegateStockModal');
      this.showToast(`${quantity} units of ${product.name} delegated to ${employee.name}.`, 'success');
    },

    populateAssigneeSelect() {
      const assigneeSelect = document.getElementById('task-assignee-select');
      assigneeSelect.innerHTML = this.state.employees.map(emp => `<option value="${emp.id}">${emp.name}</option>`).join('');
      assigneeSelect.disabled = this.state.employees.length === 0;
      document.querySelector('#createTaskModal button[type="submit"]').disabled = this.state.employees.length === 0;
    },

    handleCreateTask(e) {
      e.preventDefault();
      const form = e.target;
      const description = form.querySelector('#task-description').value;
      const assigneeId = form.querySelector('#task-assignee-select').value;

      if (!description || !assigneeId) {
        this.showToast('Please fill all task fields.', 'danger');
        return;
      }

      const newTask = {
        id: `task_${Date.now()}`,
        description,
        assigneeId,
        completed: false
      };
      this.state.tasks.push(newTask);
      this.saveState();
      this.renderCompanyOverview(); // Update all tasks list
      this.renderMyTasks(); // Update current employee's tasks if on that tab
      this.closeModal('createTaskModal');
      this.showToast('Task created successfully.', 'success');
    },

    toggleTaskStatus(taskId) {
      const task = this.state.tasks.find(t => t.id === taskId);
      if (task) {
        task.completed = !task.completed;
        this.saveState();
        this.renderCompanyOverview();
        this.renderMyTasks();
        this.showToast(`Task marked as ${task.completed ? 'completed' : 'pending'}.`, 'info');
      }
    },

    // New: Handler for saving store assignments
    handleAssignStores(e) {
        e.preventDefault();
        const employeeId = this.state.editingEmployeeId;
        if (!employeeId) return;

        const employee = this.getEmployee(employeeId);
        const selectedStoreIds = Array.from(e.target.querySelectorAll('input[name="store-access"]:checked')).map(cb => cb.value);
        
        employee.storeAccess = selectedStoreIds;
        this.saveState();
        this.closeModal('assignStoresModal');
        this.showToast('Store access updated successfully!', 'success');
        this.renderCompanyOverview(); // Re-render company overview might be useful
        // If the current Employee is the one being edited, re-render sales tab too
        if (this.state.currentEmployeeId === employeeId && this.currentTab === 'sales-expenses') {
            this.renderSalesAndExpenses();
        }
    },

    handleDelete(itemType, itemId) {
      const itemName = this.getItemNameForConfirmation(itemType, itemId);
      if (!confirm(`Are you sure you want to delete "${itemName}"? This can have cascading effects and cannot be undone.`)) {
          return;
      }
      switch (itemType) {
          case 'employee':
              this.state.employees = this.state.employees.filter(e => e.id !== itemId);
              // Clean up tasks assigned to this employee
              this.state.tasks = this.state.tasks.filter(t => t.assigneeId !== itemId);
              // Ensure currentEmployeeId is valid after deletion
              if (this.state.currentEmployeeId === itemId) {
                this.state.currentEmployeeId = this.state.employees.length > 0 ? this.state.employees[0].id : null;
              }
              break;
          case 'store':
              this.state.stores = this.state.stores.filter(s => s.id !== itemId);
              // Important: Remove this store's ID from any employee who had access to it.
              this.state.employees.forEach(emp => {
                  if (emp.storeAccess) {
                      emp.storeAccess = emp.storeAccess.filter(storeId => storeId !== itemId);
                  }
              });
              // Clean up transactions associated with this store for all employees
              this.state.employees.forEach(employee => {
                  if (employee.transactions) {
                      employee.transactions = employee.transactions.filter(t => t.storeId !== itemId);
                  }
              });
              break;
          case 'product':
              this.state.masterInventory = this.state.masterInventory.filter(p => p.id !== itemId);
              // Clean up employee inventories and transactions if product is deleted
              this.state.employees.forEach(employee => {
                  if (employee.inventory) {
                      employee.inventory = employee.inventory.filter(item => item.productId !== itemId);
                  }
                  if (employee.transactions) {
                    employee.transactions = employee.transactions.filter(t => t.productId !== itemId);
                  }
              });
              break;
          case 'task':
              this.state.tasks = this.state.tasks.filter(t => t.id !== itemId);
              break;
      }
      this.saveState();
      this.render();
      if(itemType === 'store') this.setActiveTab('stores'); // Re-activate stores tab
      this.showToast(`${itemType.charAt(0).toUpperCase() + itemType.slice(1)} deleted.`, 'success');
    },

    getItemNameForConfirmation(itemType, itemId) {
      let name = itemId; // Default to ID if not found
      switch(itemType) {
        case 'employee':
          const emp = this.getEmployee(itemId);
          if (emp) name = emp.name; break;
        case 'product':
          const prod = this.getProduct(itemId);
          if (prod) name = prod.name; break;
        case 'store':
            const store = this.getStore(itemId);
            if (store) name = store.name; break;
        case 'task':
          const task = this.state.tasks.find(t => t.id === itemId);
          if (task) name = task.description; break;
      }
      return name;
    },

    handleRecordSale(e) {
        e.preventDefault();
        const form = e.target;
        const productId = form.querySelector('#sale-product').value;
        const storeId = form.querySelector('#sale-store').value;
        const quantity = parseInt(form.querySelector('#sale-quantity').value, 10);
        const saleType = form.querySelector('#sale-type').value;
        const amount = parseFloat(form.querySelector('#sale-amount').value);

        if (!productId || !storeId || isNaN(quantity) || quantity <= 0 || isNaN(amount) || amount <= 0) {
            this.showToast('Please fill all sale fields correctly.', 'danger');
            return;
        }

        const employee = this.getEmployee(this.state.currentEmployeeId);
        const masterProduct = this.getProduct(productId);
        const employeeProduct = employee.inventory.find(item => item.productId === productId);

        if (!employee || !masterProduct || !employeeProduct || employeeProduct.stock < quantity) {
            this.showToast('Sale failed: Insufficient stock or invalid product/employee data.', 'danger');
            return;
        }

        // Deduct from employee's inventory
        employeeProduct.stock -= quantity;

        // Record transaction
        employee.transactions.push({
            id: `txn_${Date.now()}`,
            date: new Date().toISOString(),
            type: 'sale',
            productId,
            storeId, // store where sale happened
            quantity,
            saleType,
            amount
        });

        this.saveState();
        this.renderSalesAndExpenses(); // Re-render sales form to update product stock
        this.showToast('Sale recorded successfully!', 'success');
        form.reset();
        // Set default quantity back to 1
        form.querySelector('#sale-quantity').value = 1;
        // Re-populates the select elements
        this.renderSalesAndExpenses();
    },

    handleRecordExpense(e) {
      e.preventDefault();
      const form = e.target;
      const description = form.querySelector('#expense-description').value;
      const amount = parseFloat(form.querySelector('#expense-amount').value);

      if (!description || isNaN(amount) || amount <= 0) {
        this.showToast('Please fill all expense fields correctly.', 'danger');
        return;
      }

      const employee = this.getEmployee(this.state.currentEmployeeId);
      if (!employee) {
        this.showToast('No employee selected.', 'danger');
        return;
      }

      employee.transactions.push({
        id: `txn_${Date.now()}`,
        date: new Date().toISOString(),
        type: 'expense',
        description,
        amount
      });

      this.saveState();
      this.showToast('Expense recorded successfully.', 'success');
      form.reset();
    },

    handleGenerateInvoice(e) {
      e.preventDefault();
      const startDate = document.getElementById('invoice-start-date').value;
      const endDate = document.getElementById('invoice-end-date').value;

      if (!startDate || !endDate) {
        this.showToast('Please select both start and end dates for the invoice.', 'danger');
        return;
      }

      const start = new Date(startDate);
      const end = new Date(endDate);
      end.setDate(end.getDate() + 1); // Include sales up to the end of the end date

      const employee = this.getEmployee(this.state.currentEmployeeId);
      if (!employee) {
        this.showToast('No employee selected.', 'danger');
        return;
      }

      const sales = employee.transactions.filter(t => 
        t.type === 'sale' && 
        new Date(t.date) >= start && 
        new Date(t.date) < end
      );

      if (sales.length === 0) {
        this.showToast('No sales found for the selected date range.', 'info');
        return;
      }

      const totalAmount = sales.reduce((sum, sale) => sum + sale.amount, 0);
      const invoiceHtml = this.generateInvoiceHtml(employee, sales, totalAmount);
      document.getElementById('invoice-preview').innerHTML = invoiceHtml;
      this.openModal('invoiceModal');
    },

    generateInvoiceHtml(employee, sales, total) {
        const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        const companyName = "Ledgerly Business"; // Placeholder for company name
        const companyAddress = "123 Business St, Suite 400\nMetropolis, CA 90210";

        let salesRows = sales.map(s => {
            const product = this.getProduct(s.productId);
            const store = this.getStore(s.storeId);
            return `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">${new Date(s.date).toLocaleDateString()}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${product ? product.name : 'N/A'}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${store ? store.name : 'N/A'}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${s.quantity}</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${s.saleType}</td>
                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">$${s.amount.toFixed(2)}</td>
                </tr>
            `;
        }).join('');

        return `
            <div style="font-family: sans-serif; padding: 20px; color: #333;">
                <table style="width: 100%; margin-bottom: 20px;">
                    <tr>
                        <td style="width: 50%;">
                            <h1 style="color: #4f46e5; margin: 0;">INVOICE</h1>
                            <p style="margin: 5px 0;"><strong>Invoice Date:</strong> ${today}</p>
                            <p style="margin: 5px 0;"><strong>For Employee:</strong> ${employee.name} (${employee.position})</p>
                        </td>
                        <td style="text-align: right; width: 50%;">
                            <h2 style="margin: 0; color: #333;">${companyName}</h2>
                            <p style="margin: 5px 0;">${companyAddress.replace(/\n/g, '<br>')}</p>
                        </td>
                    </tr>
                </table>

                <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Date</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Product</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Store</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Qty</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #f2f2f2;">Type</th>
                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right; background-color: #f2f2f2;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${salesRows}
                        <tr>
                            <td colspan="5" style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">TOTAL SALES:</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold; color: #4f46e5;">$${total.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>

                <p style="text-align: center; color: #777;">Thank you for your business!</p>
            </div>
        `;
    },

    downloadInvoicePdf() {
      const invoiceContent = document.getElementById('invoice-preview').innerHTML;
      if (!this.pdfShiftApiKey || this.pdfShiftApiKey === 'YOUR_PDFSHIFT_API_KEY') {
        this.showToast('PDF download is currently disabled. Please provide a PDFShift API key.', 'info', 5000);
        console.warn('PDFShift API key is not configured. Download functionality skipped.');
        return;
      }
      fetch('https://api.pdfshift.io/v3/convert/부터', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Basic ${btoa(`:${this.pdfShiftApiKey}`)}`
        },
        body: JSON.stringify({
          source: invoiceContent,
          sandbox: false, // Set to true if you are using the free tier or testing
          // more options: https://pdfshift.io/documentation/api#options
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(error => { throw new Error(error.message || 'PDFShift API error'); });
        }
        return response.blob();
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `invoice_${this.getEmployee(this.state.currentEmployeeId).name}_${Date.now()}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        this.showToast('Invoice PDF downloaded!', 'success');
      })
      .catch(error => {
        console.error('Error generating PDF:', error);
        this.showToast(`Failed to download PDF: ${error.message || 'API error'}`, 'danger', 7000);
      });
    },

    generateAIPlan() {
      const employeeId = document.getElementById('ai-employee-select').value;
      const employee = this.getEmployee(employeeId);
      const outputDiv = document.getElementById('ai-plan-output');
      const generateBtn = document.getElementById('generate-plan-btn');
      const generateText = document.getElementById('generate-plan-text');
      const generateLoader = document.getElementById('generate-plan-loader');

      if (!employee) {
        outputDiv.innerHTML = `<p class="text-sepia-danger dark:text-danger">Please select a valid employee.</p>`;
        return;
      }

      generateBtn.disabled = true;
      generateText.classList.add('hidden');
      generateLoader.classList.remove('hidden');
      outputDiv.innerHTML = `<p class="text-sepia-text-secondary dark:text-gray-400">Generating plan for ${employee.name}, please wait...</p>`;

      const totalSales = employee.transactions.filter(t => t.type === 'sale').reduce((sum, t) => sum + t.amount, 0);
      const totalExpenses = employee.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
      const profit = totalSales - totalExpenses;

      this.mockGeminiAPI(employee.name, totalSales, totalExpenses, profit, employee.transactions)
        .then(response => {
          outputDiv.innerHTML = this.simpleMarkdownToHtml(response);
          this.showToast('AI plan generated!', 'success');
        })
        .catch(error => {
          console.error("AI plan generation failed:", error);
          outputDiv.innerHTML = `<p class="text-sepia-danger dark:text-danger">Failed to generate plan: ${error.message}.</p>`;
          this.showToast('Failed to generate AI plan.', 'danger');
        })
        .finally(() => {
          generateBtn.disabled = false;
          generateText.classList.remove('hidden');
          generateLoader.classList.add('hidden');
        });
    },

    // A mock function to simulate a call to a Gemini-like API
    // In a real application, this would involve a backend call.
    mockGeminiAPI(name, revenue, expenses, profit, transactions) {
      return new Promise((resolve) => {
        setTimeout(() => {
          let advice = `### Profit Improvement Plan for ${name}\n\n`;
          advice += `**Current Financials:**\n`;
          advice += `- Total Sales: $${revenue.toFixed(2)}\n`;
          advice += `- Total Expenses: $${expenses.toFixed(2)}\n`;
          advice += `- Net Profit: $${profit.toFixed(2)}\n\n`;

          if (profit < 0) {
            advice += `**Urgent Action Needed - Negative Profit!**\n`;
            advice += `It appears ${name} is currently operating at a loss. Immediate steps should focus on:\n`;
            advice += `- **Expense Reduction:** Review all expenses, especially large or recurring ones. Can any be cut or negotiated down?\n`;
            advice += `- **Sales Boost (High Margin Products):** Identify your highest profit margin products and create strategies to push their sales. A temporary discount or bundled offer could work.\n`;
            advice += `- **Customer Retention:** Focus on retaining existing customers, as acquiring new ones is often more expensive.\n`;
          } else if (profit < 500 && transactions.length > 0) {
            advice += `**Areas for Growth - Modest Profit:**\n`;
            advice += `While ${name} is profitable, there's room for significant improvement. Consider:\n`;
            advice += `- **Targeted Sales Campaigns:** Analyze past sales data to understand peak selling times or popular products. Launch campaigns around these insights.\n`;
            advice += `- **Inventory Optimization:** Ensure inventory aligns with demand. Avoid overstocking slow-moving items which tie up capital.\n`;
            advice += `- **Upselling/Cross-selling:** Train ${name} to offer complementary products or higher-tier versions of what customers are already buying.\n`;
          } else {
            advice += `**Sustaining Growth - Healthy Profit:**\n`;
            advice += `Great work, ${name}! To continue this positive trend:\n`;
            advice += `- **Expand Product Range:** Introduce new products or services that complement existing successful ones.\n`;
            advice += `- **Market Expansion:** Explore new customer segments or geographic areas your business can serve.\n`;
            advice += `- **Process Efficiency:** Look for ways to streamline daily operations to reduce overhead costs even further without sacrificing quality.\n`;
          }

          // More specific advice based on transaction history (simplified)
          const salesCount = transactions.filter(t => t.type === 'sale').length;
          const expenseCount = transactions.filter(t => t.type === 'expense').length;

          if (salesCount === 0 && expenseCount > 0) {
            advice += `- **Zero Sales Alert:** ${name} has recorded expenses but no sales. Investigate sales efforts immediately. Are products available? Is pricing competitive? Is marketing effective?\n`;
          } else if (salesCount > 0 && expenseCount === 0) {
            advice += `- **Expense Tracking:** Very few or no expenses recorded. Ensure all outgoing funds are being accurately tracked for a complete financial picture.\n`;
          }

          // Add a generic closing
          advice += `\nRemember to consistently monitor key performance indicators (KPIs) and adjust strategies as needed.`;

          resolve(advice);
        }, 1500); // Simulate network delay
      });
    },

    // Simple Markdown to HTML converter (for display purposes)
    simpleMarkdownToHtml(md) {
      let html = md
        .replace(/^### (.*$)/gim, '<h3>$1</h3>') // h3
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')   // h2
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')    // h1
        .replace(/^- (.*$)/gim, '<li>$1</li>')    // lists
        .replace(/^\* (.*$)/gim, '<li>$1</li>')   // lists
        .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>') // bold
        .replace(/\*(.*)\*/gim, '<em>$1</em>');   // italic

      // Wrap list items in ul
      html = html.replace(/(<li>.*<\/li>(\n|$))+/gim, '<ul>$&</ul>');

      // Convert remaining newlines to paragraphs
      html = html.split('\n').map(line => line.trim() ? `<p>${line}</p>` : '').join('');

      return html;
    }
  };

  app.init();
  window.app = app; 
});
</script>

</body>
</html>
